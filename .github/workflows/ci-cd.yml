name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: self-hosted
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      
    - name: è¨­å®š .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
      env:
        DOTNET_INSTALL_DIR: "C:\\actions-runner\\.dotnet"
        
    - name: é‚„åŸ NuGet å¥—ä»¶
      run: dotnet restore
      working-directory: ./betterthanvieshow
      
    - name: å»ºç½®å°ˆæ¡ˆ
      run: dotnet build --configuration Release --no-restore
      working-directory: ./betterthanvieshow
      
    - name: åŸ·è¡Œæ¸¬è©¦
      run: dotnet test --configuration Release --no-build --verbosity normal
      working-directory: ./betterthanvieshow
      continue-on-error: true
      
    - name: ç™¼å¸ƒå°ˆæ¡ˆ
      run: dotnet publish --configuration Release --output ${{ github.workspace }}\publish --no-build
      working-directory: ./betterthanvieshow
      
    # åªåœ¨æ¨é€åˆ° main åˆ†æ”¯æ™‚åŸ·è¡Œéƒ¨ç½²
    - name: åœæ­¢æ‡‰ç”¨ç¨‹å¼ (ä½¿ç”¨ app_offline.htm)
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        $offlineFile = "${{ secrets.IIS_SITE_PATH }}\app_offline.htm"
        $offlineContent = "<html><head><meta charset='UTF-8'><title>ç³»çµ±ç¶­è­·ä¸­</title><style>body{font-family:Arial;text-align:center;padding:50px;background:#f5f5f5}h1{color:#333}p{color:#666}</style></head><body><h1>ğŸ”§ ç³»çµ±ç¶­è­·ä¸­</h1><p>æˆ‘å€‘æ­£åœ¨é€²è¡Œç³»çµ±å‡ç´šï¼Œé è¨ˆ 1-2 åˆ†é˜å¾Œæ¢å¾©æœå‹™</p><p>é€ æˆä¸ä¾¿ï¼Œæ•¬è«‹è¦‹è«’ï¼</p></body></html>"
        Set-Content -Path $offlineFile -Value $offlineContent -Encoding UTF8
        Write-Host "å·²å‰µå»º app_offline.htmï¼Œæ‡‰ç”¨ç¨‹å¼å°‡å„ªé›…é—œé–‰"
        Start-Sleep -Seconds 5
      shell: powershell
      
    - name: å‚™ä»½ç¾æœ‰ç‰ˆæœ¬
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
        $backupPath = "${{ secrets.IIS_SITE_PATH }}_backup_$timestamp"
        if (Test-Path "${{ secrets.IIS_SITE_PATH }}") {
          Copy-Item -Path "${{ secrets.IIS_SITE_PATH }}" -Destination $backupPath -Recurse -Force
          Write-Host "å‚™ä»½å®Œæˆ: $backupPath"
        }
      shell: powershell
      
    - name: éƒ¨ç½²åˆ° IIS
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        # æ¸…ç†ç›®æ¨™ç›®éŒ„ï¼ˆä¿ç•™ web.config å’Œ app_offline.htmï¼‰
        $keepFiles = @("web.config", "app_offline.htm")
        Get-ChildItem -Path "${{ secrets.IIS_SITE_PATH }}" -Recurse | 
          Where-Object { $keepFiles -notcontains $_.Name } | 
          Remove-Item -Force -Recurse -ErrorAction SilentlyContinue
        
        # è¤‡è£½æ–°ç‰ˆæœ¬
        Copy-Item -Path "${{ github.workspace }}\publish\*" -Destination "${{ secrets.IIS_SITE_PATH }}" -Recurse -Force
        Write-Host "éƒ¨ç½²å®Œæˆ"
      shell: powershell
      
    - name: åŸ·è¡Œè³‡æ–™åº«é·ç§»
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        dotnet ef database update --connection "${{ secrets.AZURE_SQL_CONNECTION_STRING }}"
      working-directory: ./betterthanvieshow
      env:
        ASPNETCORE_ENVIRONMENT: Production
      continue-on-error: true
      
    - name: æ›´æ–° appsettings.Production.json
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        $configPath = "${{ secrets.IIS_SITE_PATH }}\appsettings.Production.json"
        if (Test-Path $configPath) {
          $config = Get-Content $configPath -Raw | ConvertFrom-Json
          $config.ConnectionStrings.DefaultConnection = "${{ secrets.AZURE_SQL_CONNECTION_STRING }}"
          $config.JwtSettings.SecretKey = "${{ secrets.JWT_SECRET_KEY }}"
          $config | ConvertTo-Json -Depth 10 | Set-Content $configPath
          Write-Host "ç”Ÿç”¢ç’°å¢ƒé…ç½®å·²æ›´æ–°"
        }
      shell: powershell
      
    - name: å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼ (ç§»é™¤ app_offline.htm)
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        $offlineFile = "${{ secrets.IIS_SITE_PATH }}\app_offline.htm"
        if (Test-Path $offlineFile) {
          Remove-Item -Path $offlineFile -Force
          Write-Host "å·²ç§»é™¤ app_offline.htmï¼Œæ‡‰ç”¨ç¨‹å¼æ­£åœ¨å•Ÿå‹•"
        } else {
          Write-Host "æœªæ‰¾åˆ° app_offline.htmï¼Œæ‡‰ç”¨ç¨‹å¼å¯èƒ½å·²åœ¨é‹è¡Œ"
        }
      shell: powershell
      
    - name: ç­‰å¾…æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: Start-Sleep -Seconds 10
      shell: powershell
      
    - name: å¥åº·æª¢æŸ¥
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        $maxRetries = 5
        $retryCount = 0
        $success = $false
        
        while (-not $success -and $retryCount -lt $maxRetries) {
          try {
            $response = Invoke-WebRequest -Uri "${{ secrets.SITE_URL }}/health" -TimeoutSec 10 -UseBasicParsing
            if ($response.StatusCode -eq 200) {
              Write-Host "âœ“ å¥åº·æª¢æŸ¥é€šé"
              $success = $true
            }
          } catch {
            $retryCount++
            Write-Host "å¥åº·æª¢æŸ¥å¤±æ•—ï¼Œé‡è©¦ $retryCount/$maxRetries..."
            Start-Sleep -Seconds 5
          }
        }
        
        if (-not $success) {
          Write-Host "âš  å¥åº·æª¢æŸ¥å¤±æ•—ï¼Œä½†éƒ¨ç½²å·²å®Œæˆ"
        }
      shell: powershell
      continue-on-error: true
      
    - name: éƒ¨ç½²çµæœé€šçŸ¥
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        Write-Host "========================================="
        Write-Host "éƒ¨ç½²å®Œæˆï¼"
        Write-Host "ç¶²ç«™: ${{ secrets.SITE_URL }}"
        Write-Host "æ™‚é–“: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        Write-Host "========================================="
      shell: powershell
