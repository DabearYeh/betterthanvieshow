name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
      env:
        DOTNET_INSTALL_DIR: "C:\\actions-runner\\.dotnet"
        
    - name: Restore NuGet packages
      run: dotnet restore
      working-directory: ./betterthanvieshow
      
    - name: Build project
      run: dotnet build --configuration Release --no-restore
      working-directory: ./betterthanvieshow
      
    - name: Run tests
      run: dotnet test --configuration Release --no-build --verbosity normal
      working-directory: ./betterthanvieshow
      continue-on-error: true
      
    - name: Publish project
      run: dotnet publish --configuration Release --output ${{ github.workspace }}\publish --no-build
      working-directory: ./betterthanvieshow
      
    # Deploy only when pushing to main branch
    - name: Stop application (using app_offline.htm)
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        $sitePath = "${{ secrets.IIS_SITE_PATH }}"
        if (-not (Test-Path $sitePath)) {
          New-Item -ItemType Directory -Path $sitePath -Force | Out-Null
          Write-Host "Created directory: $sitePath"
        }
        $offlineFile = "$sitePath\app_offline.htm"
        $offlineContent = "<html><head><meta charset='UTF-8'><title>Maintenance</title><style>body{font-family:Arial;text-align:center;padding:50px;background:#f5f5f5}h1{color:#333}p{color:#666}</style></head><body><h1>Site Under Maintenance</h1><p>We are upgrading the system. Service will resume in 1-2 minutes.</p><p>Thank you for your patience.</p></body></html>"
        Set-Content -Path $offlineFile -Value $offlineContent -Encoding UTF8
        Write-Host "Created app_offline.htm, application will shutdown gracefully"
        Start-Sleep -Seconds 5
      shell: powershell
      
    - name: Backup current version
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
        $backupPath = "$env:TEMP\betterthanvieshow_backup_$timestamp"
        if (Test-Path "${{ secrets.IIS_SITE_PATH }}") {
          Copy-Item -Path "${{ secrets.IIS_SITE_PATH }}" -Destination $backupPath -Recurse -Force
          Write-Host "Backup completed: $backupPath"
        }
      shell: powershell
      
    - name: Deploy to IIS
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        # Clean target directory (keep web.config and app_offline.htm)
        $keepFiles = @("web.config", "app_offline.htm")
        Get-ChildItem -Path "${{ secrets.IIS_SITE_PATH }}" -Recurse | 
          Where-Object { $keepFiles -notcontains $_.Name } | 
          Remove-Item -Force -Recurse -ErrorAction SilentlyContinue
        
        # Copy new version
        Copy-Item -Path "${{ github.workspace }}\publish\*" -Destination "${{ secrets.IIS_SITE_PATH }}" -Recurse -Force
        Write-Host "Deployment completed"
      shell: powershell
      
    - name: Ensure EF Core tools in PATH
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        echo "$env:USERPROFILE\.dotnet\tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      shell: powershell
      
    - name: Run database migrations
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        # 使用 VM 本地的 SQL Server 連線字串（整合 Windows 驗證）
        dotnet ef database update --connection "Server=localhost;Database=BetterThanVieShowDB;Trusted_Connection=True;TrustServerCertificate=True;"
      working-directory: ./betterthanvieshow
      env:
        ASPNETCORE_ENVIRONMENT: Production
      continue-on-error: true
      
    - name: Update appsettings.Production.json
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        $configPath = "${{ secrets.IIS_SITE_PATH }}\\appsettings.Production.json"
        if (Test-Path $configPath) {
          $config = Get-Content $configPath -Raw | ConvertFrom-Json
          
          # 1. Update connection string to use VM local SQL Server
          $config.ConnectionStrings.DefaultConnection = "Server=localhost;Database=BetterThanVieShowDB;Trusted_Connection=True;TrustServerCertificate=True;"
          $config.JwtSettings.SecretKey = "${{ secrets.JWT_SECRET_KEY }}"
          
          # 2. Add or update LinePay section
          if (-not $config.LinePay) { $config | Add-Member -MemberType NoteProperty -Name "LinePay" -Value @{} }
          $config.LinePay.ChannelId = "${{ secrets.LINEPAY_CHANNEL_ID }}"
          $config.LinePay.ChannelSecret = "${{ secrets.LINEPAY_CHANNEL_SECRET }}"
          $config.LinePay.IsSandbox = $true
          $config.LinePay.ApiBaseUrl = "https://sandbox-api-pay.line.me"
          $config.LinePay.FrontendBaseUrl = "https://better-than-vieshow-user.vercel.app"
          $config.LinePay.ConfirmUrlPath = "/checkout/confirm"
          $config.LinePay.CancelUrlPath = "/checkout/cancel"
          
          # 3. Save to file
          $config | ConvertTo-Json -Depth 10 | Set-Content $configPath
          Write-Host "Production configuration updated with VM local SQL Server"
        }
      shell: powershell
      
    - name: Start application (remove app_offline.htm)
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        $offlineFile = "${{ secrets.IIS_SITE_PATH }}\app_offline.htm"
        if (Test-Path $offlineFile) {
          Remove-Item -Path $offlineFile -Force
          Write-Host "Removed app_offline.htm, application is starting"
        } else {
          Write-Host "app_offline.htm not found, application may already be running"
        }
      shell: powershell
      
    - name: Wait for application to start
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: Start-Sleep -Seconds 10
      shell: powershell
      
    - name: Health check
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        $maxRetries = 5
        $retryCount = 0
        $success = $false
        
        while (-not $success -and $retryCount -lt $maxRetries) {
          try {
            $response = Invoke-WebRequest -Uri "${{ secrets.SITE_URL }}/health" -TimeoutSec 10 -UseBasicParsing
            if ($response.StatusCode -eq 200) {
              Write-Host "Health check passed"
              $success = $true
            }
          } catch {
            $retryCount++
            Write-Host "Health check failed, retrying $retryCount/$maxRetries..."
            Start-Sleep -Seconds 5
          }
        }
        
        if (-not $success) {
          Write-Host "Warning: Health check failed, but deployment is complete"
        }
      shell: powershell
      continue-on-error: true
      
    - name: Deployment notification
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        Write-Host "========================================="
        Write-Host "Deployment Completed!"
        Write-Host "Site: ${{ secrets.SITE_URL }}"
        Write-Host "Time: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        Write-Host "========================================="
      shell: powershell
