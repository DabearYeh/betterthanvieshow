name: CD - Deploy to Azure VM

# è§¸ç™¼æ¢ä»¶ï¼šç•¶ main åˆ†æ”¯æœ‰æ–°çš„ push ä¸” CI æˆåŠŸæ™‚
on:
  workflow_run:
    workflows: ["CI - Build and Test"]
    types:
      - completed
    branches: [ "main" ]

jobs:
  deploy:
    # åªæœ‰ç•¶ CI workflow æˆåŠŸæ™‚æ‰åŸ·è¡Œéƒ¨ç½²
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: self-hosted  # ä½¿ç”¨ Azure VM ä¸Šçš„ Self-Hosted Runner
    
    steps:
    # 1. ä¸‹è¼‰ CI workflow å»ºç½®çš„ç”¢ç‰©
    - name: ğŸ“¦ Download build artifact
      uses: actions/download-artifact@v4
      with:
        name: betterthanvieshow-build
        path: ${{ github.workspace }}/publish/
        run-id: ${{ github.event.workflow_run.id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}
    
    # 2. åœæ­¢ IIS Application Poolï¼ˆé¿å…æª”æ¡ˆé–å®šï¼‰
    - name: ğŸ›‘ Stop IIS Application Pool
      shell: powershell
      run: |
        Write-Host "åœæ­¢ Application Pool..."
        Stop-WebAppPool -Name "${{ secrets.IIS_APP_POOL_NAME }}"
        Start-Sleep -Seconds 3
    
    # 3. å‚™ä»½ç•¶å‰ç‰ˆæœ¬ï¼ˆå¯é¸ï¼Œä½†å»ºè­°ï¼‰
    - name: ğŸ’¾ Backup current version
      shell: powershell
      run: |
        $backupPath = "${{ secrets.IIS_SITE_PATH }}_backup_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
        if (Test-Path "${{ secrets.IIS_SITE_PATH }}") {
          Write-Host "å‚™ä»½ç•¶å‰ç‰ˆæœ¬åˆ°: $backupPath"
          Copy-Item -Path "${{ secrets.IIS_SITE_PATH }}" -Destination $backupPath -Recurse -Force
          
          # åªä¿ç•™æœ€è¿‘ 5 å€‹å‚™ä»½
          Get-ChildItem -Path "$(Split-Path ${{ secrets.IIS_SITE_PATH }})" -Filter "*_backup_*" | 
            Sort-Object CreationTime -Descending | 
            Select-Object -Skip 5 | 
            Remove-Item -Recurse -Force
        }
    
    # 4. è¤‡è£½æ–°ç‰ˆæœ¬æª”æ¡ˆåˆ°ç¶²ç«™ç›®éŒ„
    - name: ğŸ“‚ Deploy files to IIS
      shell: powershell
      run: |
        Write-Host "éƒ¨ç½²æª”æ¡ˆåˆ°: ${{ secrets.IIS_SITE_PATH }}"
        
        # ç¢ºä¿ç›®æ¨™ç›®éŒ„å­˜åœ¨
        if (-not (Test-Path "${{ secrets.IIS_SITE_PATH }}")) {
          New-Item -ItemType Directory -Path "${{ secrets.IIS_SITE_PATH }}" -Force
        }
        
        # è¤‡è£½æª”æ¡ˆï¼ˆä¿ç•™ appsettings.json ç­‰é…ç½®æª”æ¡ˆï¼‰
        Copy-Item -Path "${{ github.workspace }}/publish/*" -Destination "${{ secrets.IIS_SITE_PATH }}" -Recurse -Force
        
        Write-Host "âœ… æª”æ¡ˆéƒ¨ç½²å®Œæˆ"
    
    # 5. å•Ÿå‹• IIS Application Pool
    - name: â–¶ï¸ Start IIS Application Pool
      shell: powershell
      run: |
        Write-Host "å•Ÿå‹• Application Pool..."
        Start-WebAppPool -Name "${{ secrets.IIS_APP_POOL_NAME }}"
        Start-Sleep -Seconds 3
        
        # æª¢æŸ¥ç‹€æ…‹
        $pool = Get-WebAppPoolState -Name "${{ secrets.IIS_APP_POOL_NAME }}"
        Write-Host "Application Pool ç‹€æ…‹: $($pool.Value)"
    
    # 6. æ¸…ç†å·¥ä½œç›®éŒ„
    - name: ğŸ§¹ Cleanup
      shell: powershell
      run: |
        Write-Host "æ¸…ç†æš«å­˜æª”æ¡ˆ..."
        Remove-Item -Path "${{ github.workspace }}/publish" -Recurse -Force -ErrorAction SilentlyContinue
    
    # 7. éƒ¨ç½²å®Œæˆé€šçŸ¥
    - name: âœ… Deployment Complete
      shell: powershell
      run: |
        Write-Host "========================================="
        Write-Host "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
        Write-Host "ğŸ“ ç’°å¢ƒ: Demo/Staging (ç•¢æ¥­å°ˆæ¡ˆ)"
        Write-Host "ğŸŒ ç¶²ç«™è·¯å¾‘: ${{ secrets.IIS_SITE_PATH }}"
        Write-Host "ğŸ”„ Application Pool: ${{ secrets.IIS_APP_POOL_NAME }}"
        Write-Host "â° éƒ¨ç½²æ™‚é–“: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        Write-Host "========================================="
