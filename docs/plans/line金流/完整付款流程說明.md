# LINE Pay å®Œæ•´ä»˜æ¬¾æµç¨‹èªªæ˜

## ğŸ“– æµç¨‹ç¸½è¦½

æœ¬æ–‡æª”ä»¥ç™½è©±æ–‡æ–¹å¼èªªæ˜å¾ä½¿ç”¨è€…é¸åº§åˆ°ä»˜æ¬¾å®Œæˆçš„å®Œæ•´æµç¨‹ï¼ŒåŒ…å«å‰ç«¯ã€å¾Œç«¯ã€LINE Pay ä¹‹é–“çš„æ‰€æœ‰äº’å‹•ã€‚

---

## ğŸ¬ å®Œæ•´æµç¨‹åœ–

```
ç¬¬é›¶éšæ®µï¼šå»ºç«‹è¨‚å–®
  â†“
ç¬¬ä¸€éšæ®µï¼šæº–å‚™ä»˜æ¬¾ (The Setup)
  â†“
ä¸­å ´ä¼‘æ¯ï¼šä½¿ç”¨è€…äº’å‹• (User Action)
  â†“
ç¬¬äºŒéšæ®µï¼šç¢ºèªä»˜æ¬¾ (The Closing)
  â†“
å®Œæˆï¼
```

---

## ç¬¬é›¶éšæ®µï¼šå»ºç«‹è¨‚å–®

### ç›®æ¨™
ä½¿ç”¨è€…é¸å¥½åº§ä½å¾Œï¼Œåœ¨ç³»çµ±ä¸­å»ºç«‹è¨‚å–®ä¸¦é–å®šåº§ä½ã€‚

### æµç¨‹æ­¥é©Ÿ

#### 1. ä½¿ç”¨è€…æ“ä½œ
- **å‹•ä½œ**ï¼šé¸æ“‡åº§ä½ï¼ˆä¾‹å¦‚ï¼šA3, A4, A5 ä¸‰å€‹åº§ä½ï¼‰
- **å‹•ä½œ**ï¼šé»æ“Šã€Œç¢ºèªè¨‚å–®ã€æŒ‰éˆ•

#### 2. å‰ç«¯ â†’ å¾Œç«¯
```http
POST /api/orders
Content-Type: application/json
Authorization: Bearer {userToken}

{
  "showTimeId": 123,
  "seatIds": [45, 46, 47]
}
```

**æƒ…å¢ƒèªªæ˜**ï¼š
- å®¢äººèªªï¼šã€Œæˆ‘è¦è¨‚å ´æ¬¡ 123 çš„é€™ 3 å€‹åº§ä½ã€

#### 3. å¾Œç«¯è™•ç†
ä½ çš„ `OrderService.CreateOrderAsync()` åŸ·è¡Œä»¥ä¸‹å‹•ä½œï¼š

1. âœ… é©—è­‰å ´æ¬¡å­˜åœ¨
2. âœ… é©—è­‰æ™‚åˆ»è¡¨ç‹€æ…‹ç‚º OnSale
3. âœ… é©—è­‰åº§ä½æœªè¢«è¨‚è³¼
4. âœ… è¨ˆç®—ç¥¨åƒ¹ï¼ˆæ ¹æ“šå½±å»³é¡å‹ï¼‰
5. âœ… ç”Ÿæˆè¨‚å–®ç·¨è™Ÿï¼ˆä¾‹å¦‚ï¼š`#ABC-12345`ï¼‰
6. âœ… **å»ºç«‹ Order è¨˜éŒ„**
   ```csharp
   Order.Status = "Pending"        // æœªä»˜æ¬¾
   Order.ExpiresAt = Now + 5åˆ†é˜   // ä»˜æ¬¾æœŸé™
   Order.TotalPrice = 1140         // ç¸½é‡‘é¡
   ```
7. âœ… **å»ºç«‹ Ticket è¨˜éŒ„**
   ```csharp
   Ticket.Status = "Pending"       // å¾…æ”¯ä»˜
   // åº§ä½ç«‹å³é–å®šï¼
   ```
8. âœ… é€é SignalR é€šçŸ¥åº§ä½å·²é–å®š

#### 4. å¾Œç«¯ â†’ å‰ç«¯
```json
{
  "orderId": 789,
  "orderNumber": "#ABC-12345",
  "totalPrice": 1140,
  "expiresAt": "2025-12-29T15:30:00Z",
  "ticketCount": 3,
  "seats": [...]
}
```

**æƒ…å¢ƒèªªæ˜**ï¼š
- å¾Œç«¯èªªï¼šã€Œè¨‚å–®å·²å»ºç«‹ï¼è¨‚å–®è™Ÿæ˜¯ #ABC-12345ï¼Œç¸½å…± 1140 å…ƒï¼Œè«‹åœ¨ 5 åˆ†é˜å…§å®Œæˆä»˜æ¬¾ã€

#### 5. å‰ç«¯é¡¯ç¤º
- é¡¯ç¤ºè¨‚å–®æ‘˜è¦é é¢
- é¡¯ç¤º 5 åˆ†é˜å€’æ•¸è¨ˆæ™‚å™¨
- é¡¯ç¤ºã€Œå‰å¾€ä»˜æ¬¾ã€æŒ‰éˆ•

---

## ç¬¬ä¸€éšæ®µï¼šæº–å‚™ä»˜æ¬¾ (The Setup)

### ç›®æ¨™
æ‹¿åˆ°ã€Œä»˜æ¬¾ç¶²å€ã€ï¼ŒæŠŠå®¢äººé€å» LINE Pay é‚£é‚Šã€‚

### æµç¨‹æ­¥é©Ÿ

#### 1. ä½¿ç”¨è€…æ“ä½œ
- **å‹•ä½œ**ï¼šé»æ“Šã€Œå‰å¾€ä»˜æ¬¾ã€æŒ‰éˆ•

#### 2. å‰ç«¯ â†’ å¾Œç«¯
```http
POST /api/payments/line-pay/request
Content-Type: application/json
Authorization: Bearer {userToken}

{
  "orderId": 789
}
```

**æƒ…å¢ƒèªªæ˜**ï¼š
- å‰ç«¯èªªï¼šã€Œæˆ‘çš„è¨‚å–® ID æ˜¯ 789ï¼Œè¦ä»˜æ¬¾äº†ï¼ã€

#### 3. å¾Œç«¯è™•ç†

ä½ çš„ `LinePayService.CreatePaymentRequestAsync()` åŸ·è¡Œä»¥ä¸‹å‹•ä½œï¼š

1. âœ… æŸ¥è©¢è¨‚å–®è³‡è¨Š
   ```csharp
   var order = await _orderRepository.GetByIdAsync(orderId);
   // æª¢æŸ¥è¨‚å–®ç‹€æ…‹æ˜¯å¦ç‚º Pending
   // æª¢æŸ¥æ˜¯å¦å·²éæœŸ
   ```

2. âœ… çµ„è£ LINE Pay Request API åƒæ•¸
   ```csharp
   var requestBody = new
   {
       amount = order.TotalPrice,           // 1140
       currency = "TWD",
       orderId = order.OrderNumber,          // "#ABC-12345"
       packages = new[]
       {
           new
           {
               id = "1",
               amount = order.TotalPrice,
               products = new[]
               {
                   new
                   {
                       name = "é›»å½±ç¥¨åˆ¸",
                       quantity = order.TicketCount,     // 3
                       price = order.TotalPrice / order.TicketCount
                   }
               }
           }
       },
       redirectUrls = new
       {
           confirmUrl = "https://yourdomain.com/checkout/confirm?orderId=789",
           cancelUrl = "https://yourdomain.com/checkout/cancel?orderId=789"
       }
   };
   ```

#### 4. å¾Œç«¯ â†’ LINE Pay
```http
POST https://sandbox-api-pay.line.me/v3/payments/request
Content-Type: application/json
X-LINE-ChannelId: {Your Channel ID}
X-LINE-Authorization: {HMAC Signature}
X-LINE-Authorization-Nonce: {UUID}

{
  "amount": 1140,
  "currency": "TWD",
  "orderId": "#ABC-12345",
  "packages": [...],
  "redirectUrls": {...}
}
```

**æƒ…å¢ƒèªªæ˜**ï¼š
- å¾Œç«¯ç”¨ HttpClient è·‘è…¿
- å¾Œç«¯èªªï¼šã€ŒLINE å¤§å“¥ï¼Œæˆ‘æœ‰ç­† 1140 å…ƒçš„è¨‚å–®ï¼Œè¨‚å–®è™Ÿæ˜¯ #ABC-12345ï¼Œè«‹çµ¦æˆ‘ä»˜æ¬¾ç¶²å€ã€

**æŠ€è¡“é‡é»**ï¼š
- å¿…é ˆå¸¶ä¸Š HMAC-SHA256 ç°½ç« ï¼ˆ`X-LINE-Authorization`ï¼‰
- ç°½ç« è¨Šæ¯ï¼š`channelSecret + apiPath + requestBodyJSON + nonce`

#### 5. LINE Pay â†’ å¾Œç«¯
```json
{
  "returnCode": "0000",
  "returnMessage": "Success.",
  "info": {
    "paymentUrl": {
      "web": "https://sandbox-web-pay.line.me/web/payment/wait?transactionReserveId=...",
      "app": "line://pay/payment/..."
    },
    "transactionId": 2025122901234567890,
    "paymentAccessToken": "056579816895"
  }
}
```

**æƒ…å¢ƒèªªæ˜**ï¼š
- LINE Pay èªªï¼šã€Œå¥½ï¼Œé€™æ˜¯ paymentUrlï¼ˆç¶²å€ï¼‰å’Œ transactionIdï¼ˆäº¤æ˜“è™Ÿï¼‰ã€

#### 6. å¾Œç«¯è™•ç†ï¼ˆå¯é¸ï¼‰
```csharp
// å„²å­˜ transactionId ä¾›å¾ŒçºŒè¿½è¹¤
order.PaymentTransactionId = response.info.transactionId.ToString();
await _orderRepository.UpdateAsync(order);
```

#### 7. å¾Œç«¯ â†’ å‰ç«¯
```json
{
  "paymentUrl": "https://sandbox-web-pay.line.me/web/payment/wait?...",
  "transactionId": "2025122901234567890"
}
```

**æƒ…å¢ƒèªªæ˜**ï¼š
- å¾Œç«¯èªªï¼šã€Œæ‹¿åˆ°ä»˜æ¬¾ç¶²å€äº†ï¼Œå¿«å»ä»˜æ¬¾å§ï¼ã€

#### 8. å‰ç«¯åŸ·è¡Œè·³è½‰
```javascript
// PC ç‰ˆï¼šé–‹å•Ÿå½ˆå‡ºè¦–çª—
window.open(response.paymentUrl, 'LINE Pay', 'width=600,height=800');

// æˆ–ç›´æ¥è·³è½‰
window.location.href = response.paymentUrl;
```

**çµæœ**ï¼š
- å®¢äººçš„ç€è¦½å™¨é›¢é–‹ä½ çš„ç¶²ç«™
- è·³è½‰åˆ° LINE Pay ä»˜æ¬¾é é¢

---

## ä¸­å ´ä¼‘æ¯ï¼šä½¿ç”¨è€…äº’å‹• (User Action)

### é€™æ®µæ™‚é–“ç™¼ç”Ÿä»€éº¼äº‹ï¼Ÿ

**ä½ çš„å¾Œç«¯åœ¨ä¼‘æ¯**ï¼Œåªæœ‰å®¢äººåœ¨æ“ä½œ LINE Pay é é¢ã€‚

#### 1. å®¢äººæ“ä½œ
- åœ¨ LINE ä»‹é¢ä¸Šçœ‹åˆ°è¨‚å–®è³‡è¨Š
- çœ‹åˆ°é‡‘é¡ï¼šNT$ 1,140
- çœ‹åˆ°å•†å“ï¼šé›»å½±ç¥¨åˆ¸ x3
- é¸æ“‡ä»˜æ¬¾æ–¹å¼ï¼ˆLINE Points æˆ–ä¿¡ç”¨å¡ï¼‰
- è¼¸å…¥å¯†ç¢¼ / åˆ·è‡‰é©—è­‰
- æŒ‰ä¸‹ã€Œç¢ºèªä»˜æ¬¾ã€

#### 2. LINE Pay è™•ç†
- é©—è­‰ä»˜æ¬¾å¯†ç¢¼
- æ‰£æ¬¾æˆåŠŸ
- **æŠŠå®¢äººè¸¢å›ä¾†**ï¼ˆRedirectï¼‰ä½ çš„ç¶²ç«™

#### 3. è·³è½‰å›ä½ çš„ç¶²ç«™
```
https://yourdomain.com/checkout/confirm?transactionId=2025122901234567890&orderId=789
```

**ç¶²å€åƒæ•¸èªªæ˜**ï¼š
- `transactionId`ï¼šLINE Pay äº¤æ˜“è™Ÿï¼ˆé‡è¦ï¼ç”¨æ–¼ç¢ºèªä»˜æ¬¾ï¼‰
- `orderId`ï¼šä½ çš„è¨‚å–® IDï¼ˆæ–¹ä¾¿å‰ç«¯è­˜åˆ¥ï¼‰

---

## ç¬¬äºŒéšæ®µï¼šç¢ºèªä»˜æ¬¾ (The Closing)

### ç›®æ¨™
å®¢äººå›ä¾†äº†ï¼Œè¶•å¿«è·Ÿ LINE Pay èªªã€Œæˆ‘è¦æ”¶éŒ¢ã€ã€‚

### æµç¨‹æ­¥é©Ÿ

#### 1. å‰ç«¯è¼‰å…¥ Confirm é é¢
```javascript
// Vue.js / React ç¯„ä¾‹
mounted() {
  const urlParams = new URLSearchParams(window.location.search);
  const transactionId = urlParams.get('transactionId');
  const orderId = urlParams.get('orderId');
  
  // ç«‹å³å‘¼å«ç¢ºèª API
  this.confirmPayment(transactionId, orderId);
}
```

#### 2. å‰ç«¯ â†’ å¾Œç«¯
```http
POST /api/payments/line-pay/confirm
Content-Type: application/json
Authorization: Bearer {userToken}

{
  "transactionId": "2025122901234567890",
  "orderId": 789
}
```

**æƒ…å¢ƒèªªæ˜**ï¼š
- å‰ç«¯èªªï¼šã€Œå®¢äººå¾ LINE å›ä¾†äº†ï¼å¸¶è‘— transactionIdï¼Œè«‹ç¢ºèªé€™ç­†äº¤æ˜“ï¼ã€

#### 3. å¾Œç«¯è™•ç†

ä½ çš„ `LinePayService.ConfirmPaymentAsync()` åŸ·è¡Œä»¥ä¸‹å‹•ä½œï¼š

1. âœ… æŸ¥è©¢è¨‚å–®è³‡è¨Š
   ```csharp
   var order = await _orderRepository.GetByIdAsync(orderId);
   // æª¢æŸ¥è¨‚å–®ç‹€æ…‹ï¼ˆå¿…é ˆæ˜¯ Pendingï¼‰
   // æª¢æŸ¥é‡‘é¡
   ```

2. âœ… çµ„è£ LINE Pay Confirm API åƒæ•¸
   ```csharp
   var requestBody = new
   {
       amount = order.TotalPrice,    // 1140 (å¿…é ˆèˆ‡ Request ä¸€è‡´)
       currency = "TWD"
   };
   ```

#### 4. å¾Œç«¯ â†’ LINE Pay
```http
POST https://sandbox-api-pay.line.me/v3/payments/2025122901234567890/confirm
Content-Type: application/json
X-LINE-ChannelId: {Your Channel ID}
X-LINE-Authorization: {HMAC Signature}
X-LINE-Authorization-Nonce: {UUID}

{
  "amount": 1140,
  "currency": "TWD"
}
```

**æƒ…å¢ƒèªªæ˜**ï¼š
- å¾Œç«¯å†æ¬¡ç”¨ HttpClient è¯çµ¡ LINE
- å¾Œç«¯èªªï¼šã€Œé‡å°äº¤æ˜“è™Ÿ 2025122901234567890ï¼Œé‡‘é¡ 1140 å…ƒï¼Œæˆ‘è¦æ­£å¼è«‹æ¬¾ï¼ˆCaptureï¼‰ï¼ã€

**æŠ€è¡“é‡é»**ï¼š
- ä¸€æ¨£è¦å¸¶ HMAC-SHA256 ç°½ç« 
- é‡‘é¡å¿…é ˆèˆ‡ Request API æ™‚å®Œå…¨ä¸€è‡´
- transactionId æ”¾åœ¨ URL è·¯å¾‘ä¸­

#### 5. LINE Pay â†’ å¾Œç«¯
```json
{
  "returnCode": "0000",
  "returnMessage": "OK",
  "info": {
    "orderId": "#ABC-12345",
    "transactionId": 2025122901234567890,
    "payInfo": [
      {
        "method": "BALANCE",
        "amount": 1140
      }
    ]
  }
}
```

**æƒ…å¢ƒèªªæ˜**ï¼š
- LINE Pay èªªï¼šã€ŒSuccess (0000)ï¼ŒéŒ¢å·²ç¶“æ‰£äº†ï¼Œäº¤æ˜“å®Œæˆï¼ã€

#### 6. å¾Œç«¯æ›´æ–°è³‡æ–™åº«
```csharp
// 1. æ›´æ–°è¨‚å–®ç‹€æ…‹
order.Status = "Paid";
order.PaymentTransactionId = transactionId;

// 2. æ›´æ–°æ‰€æœ‰ç¥¨åˆ¸ç‹€æ…‹
foreach (var ticket in order.Tickets)
{
    ticket.Status = "Unused";
    
    // 3. ç”Ÿæˆ QR Code
    ticket.QrCode = GenerateQrCode(new
    {
        ticketNumber = ticket.TicketNumber,
        movieTitle = order.ShowTime.Movie.Title,
        theaterName = order.ShowTime.Theater.Name,
        showDate = order.ShowTime.ShowDate,
        startTime = order.ShowTime.StartTime,
        seatInfo = $"{ticket.Seat.RowName}{ticket.Seat.ColumnNumber}"
    });
}

// 4. å„²å­˜è®Šæ›´
await _dbContext.SaveChangesAsync();
```

#### 7. å¾Œç«¯ â†’ å‰ç«¯
```json
{
  "success": true,
  "message": "ä»˜æ¬¾æˆåŠŸ",
  "order": {
    "orderNumber": "#ABC-12345",
    "status": "Paid",
    "tickets": [
      {
        "ticketNumber": "12345678",
        "qrCode": "data:image/png;base64,...",
        "seat": "A3"
      },
      {
        "ticketNumber": "12345679",
        "qrCode": "data:image/png;base64,...",
        "seat": "A4"
      },
      {
        "ticketNumber": "12345680",
        "qrCode": "data:image/png;base64,...",
        "seat": "A5"
      }
    ]
  }
}
```

**æƒ…å¢ƒèªªæ˜**ï¼š
- å¾Œç«¯èªªï¼šã€Œäº¤æ˜“æˆåŠŸï¼é€™æ˜¯ä½ çš„ç¥¨åˆ¸ QR Codeã€

#### 8. å‰ç«¯é¡¯ç¤ºçµæœ
- âœ… é¡¯ç¤ºä»˜æ¬¾æˆåŠŸè¨Šæ¯
- âœ… é¡¯ç¤ºè¨‚å–®ç·¨è™Ÿï¼š#ABC-12345
- âœ… é¡¯ç¤ºæ‰€æœ‰ç¥¨åˆ¸çš„ QR Code
- âœ… æä¾›ä¸‹è¼‰ç¥¨åˆ¸åŠŸèƒ½
- âœ… æä¾›åˆ†äº«åŠŸèƒ½

---

## ğŸ‰ å®Œæˆï¼

æ•´å€‹ä»˜æ¬¾æµç¨‹çµæŸï¼Œå®¢äººç¾åœ¨æ“æœ‰ï¼š
- âœ… å·²ä»˜æ¬¾çš„è¨‚å–®ï¼ˆOrder.Status = "Paid"ï¼‰
- âœ… å¯ä½¿ç”¨çš„ç¥¨åˆ¸ï¼ˆTicket.Status = "Unused"ï¼‰
- âœ… ç¥¨åˆ¸ QR Codeï¼ˆå¯ç”¨æ–¼å…¥å ´é©—ç¥¨ï¼‰

---

## âš ï¸ ç•°å¸¸æƒ…æ³è™•ç†

### æƒ…å¢ƒ 1ï¼šä½¿ç”¨è€…åœ¨ LINE Pay é é¢é»æ“Šã€Œå–æ¶ˆã€

**æµç¨‹**ï¼š
1. LINE Pay è·³è½‰è‡³ `cancelUrl`
   ```
   https://yourdomain.com/checkout/cancel?orderId=789
   ```

2. å‰ç«¯é¡¯ç¤ºã€Œä»˜æ¬¾å·²å–æ¶ˆã€é é¢

3. è¨‚å–®ç¶­æŒ `Pending` ç‹€æ…‹

4. **5 åˆ†é˜å¾Œ**ï¼ŒèƒŒæ™¯æœå‹™è‡ªå‹•å–æ¶ˆè¨‚å–®
   - Order.Status â†’ "Cancelled"
   - Ticket.Status â†’ "Expired"
   - åº§ä½è‡ªå‹•é‡‹æ”¾

### æƒ…å¢ƒ 2ï¼šä½¿ç”¨è€…å®Œæˆ LINE Pay ä½†æœªç¢ºèªï¼ˆé—œé–‰è¦–çª—ï¼‰

**å•é¡Œ**ï¼š
- ä½¿ç”¨è€…åœ¨ LINE Pay å®Œæˆä»˜æ¬¾
- ä½†åœ¨è·³è½‰å› `confirmUrl` å‰é—œé–‰è¦–çª—
- å°è‡´å¾Œç«¯ç„¡æ³•æ”¶åˆ° Confirm è«‹æ±‚

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. å‰ç«¯åœ¨è¨‚å–®åˆ—è¡¨é é¢æª¢æŸ¥è¨‚å–®ç‹€æ…‹
2. å¦‚æœç™¼ç¾è¨‚å–®æœ‰ `transactionId` ä½†ç‹€æ…‹ä»æ˜¯ `Pending`
3. è‡ªå‹•å‘¼å« Confirm API å®Œæˆä»˜æ¬¾

**æˆ–è€…**ï¼š
1. è¨­å®š Webhookï¼ˆLINE Pay ä¸»å‹•é€šçŸ¥ï¼‰
2. ç•¶ä»˜æ¬¾å®Œæˆæ™‚ï¼ŒLINE Pay æœƒä¸»å‹•å‘¼å«ä½ çš„ API
3. ä½ çš„å¾Œç«¯è‡ªå‹•åŸ·è¡Œ Confirm

### æƒ…å¢ƒ 3ï¼š5 åˆ†é˜è¶…æ™‚æœªä»˜æ¬¾

**æµç¨‹**ï¼š
1. èƒŒæ™¯æœå‹™ `OrderExpirationService` æ¯åˆ†é˜æƒæ
2. ç™¼ç¾è¨‚å–®å·²éæœŸä¸”ç‹€æ…‹ä»æ˜¯ `Pending`
3. è‡ªå‹•å–æ¶ˆè¨‚å–®
   ```csharp
   order.Status = "Cancelled";
   foreach (var ticket in order.Tickets)
   {
       ticket.Status = "Expired";
   }
   ```
4. é€é SignalR é€šçŸ¥å‰ç«¯åº§ä½å·²é‡‹æ”¾

### æƒ…å¢ƒ 4ï¼šLINE Pay API å‘¼å«å¤±æ•—

**å¯èƒ½åŸå› **ï¼š
- ç°½ç« éŒ¯èª¤
- ç¶²è·¯é€¾æ™‚
- LINE Pay ä¼ºæœå™¨æš«æ™‚ç„¡æ³•å›æ‡‰

**è™•ç†æ–¹å¼**ï¼š
1. è¨˜éŒ„è©³ç´°éŒ¯èª¤ Log
2. å›å‚³å‹å–„éŒ¯èª¤è¨Šæ¯çµ¦å‰ç«¯
3. æä¾›é‡è©¦æ©Ÿåˆ¶
4. è¨‚å–®ç¶­æŒ `Pending` ç‹€æ…‹ï¼ˆç­‰å¾…é‡è©¦æˆ–è¶…æ™‚å–æ¶ˆï¼‰

---

## ğŸ“‹ æŠ€è¡“é‡é»å›é¡§

### 1. è¨‚å–®å»ºç«‹æ™‚æ©Ÿ
- âœ… **åœ¨ä»˜æ¬¾è«‹æ±‚ä¹‹å‰**å°±å»ºç«‹è¨‚å–®
- âœ… è¨‚å–®å»ºç«‹æ™‚åº§ä½ç«‹å³é–å®š
- âœ… 5 åˆ†é˜å€’æ•¸å¾è¨‚å–®å»ºç«‹é–‹å§‹

### 2. API å‘¼å«é †åº
```
POST /api/orders (å»ºç«‹è¨‚å–®)
  â†“
POST /api/payments/line-pay/request (ç™¼èµ·ä»˜æ¬¾)
  â†“
[ä½¿ç”¨è€…åœ¨ LINE Pay æ“ä½œ]
  â†“
POST /api/payments/line-pay/confirm (ç¢ºèªä»˜æ¬¾)
```

### 3. ç‹€æ…‹è½‰æ›æ™‚æ©Ÿ

**Order ç‹€æ…‹**ï¼š
- `Pending` â†’ è¨‚å–®å»ºç«‹æ™‚
- `Paid` â†’ Confirm API æˆåŠŸæ™‚
- `Cancelled` â†’ è¶…æ™‚æˆ–ä½¿ç”¨è€…å–æ¶ˆæ™‚

**Ticket ç‹€æ…‹**ï¼š
- `Pending` â†’ è¨‚å–®å»ºç«‹æ™‚ï¼ˆåº§ä½é–å®šï¼‰
- `Unused` â†’ ä»˜æ¬¾æˆåŠŸæ™‚
- `Expired` â†’ è¶…æ™‚æˆ–è¨‚å–®å–æ¶ˆæ™‚ï¼ˆåº§ä½é‡‹æ”¾ï¼‰

### 4. é—œéµè³‡æ–™å„²å­˜

**å¿…é ˆå„²å­˜**ï¼š
- `Order.PaymentTransactionId` â†’ ç”¨æ–¼å°å¸³å’Œè¿½è¹¤
- `Order.Status` â†’ è¨‚å–®ç‹€æ…‹
- `Ticket.Status` â†’ ç¥¨åˆ¸ç‹€æ…‹
- `Ticket.QrCode` â†’ ç¥¨åˆ¸ QR Code

---

## ğŸ”— ç›¸é—œæ–‡æª”

- [LINE_Pay_å®˜æ–¹APIæ–‡æª”æ•´ç†.md](./LINE_Pay_å®˜æ–¹APIæ–‡æª”æ•´ç†.md) - API æŠ€è¡“ç´°ç¯€
- [æµç¨‹åˆ†æ.md](./æµç¨‹åˆ†æ.md) - æ¶æ§‹åˆ†æèˆ‡å¯¦ä½œè¦åŠƒ
- [README.md](./README.md) - æ–‡æª”ç´¢å¼•èˆ‡å¿«é€ŸæŒ‡å—

---

**æ–‡æª”ç‰ˆæœ¬ï¼š** v1.0  
**å»ºç«‹æ—¥æœŸï¼š** 2025-12-29  
**æœ€å¾Œæ›´æ–°ï¼š** 2025-12-29
