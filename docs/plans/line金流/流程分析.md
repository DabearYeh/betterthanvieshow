# LINE Pay é‡‘æµæ•´åˆåˆ†æ

## ğŸ“Š ä»˜æ¬¾æµç¨‹åœ–æ¦‚è¿°

æœ¬æ–‡æª”åˆ†æ LINE Pay ä»˜æ¬¾æµç¨‹èˆ‡å°ˆæ¡ˆè¦æ ¼çš„å¥‘åˆåº¦ï¼Œä¸¦æå‡ºå…·é«”å¯¦ä½œå»ºè­°ã€‚

### æµç¨‹åœ–éšæ®µèªªæ˜

ä»˜æ¬¾æµç¨‹åœ–åŒ…å«å››å€‹ä¸»è¦éšæ®µï¼š

1. **ä»˜æ¬¾è«‹æ±‚**ï¼ˆæœ€å·¦æ¬„ï¼‰- é›»å½±é™¢ç³»çµ±
2. **LINE Payæˆæ¬Š**ï¼ˆå·¦äºŒæ¬„ï¼‰- LINE Pay å¹³å°
3. **ä»˜æ¬¾æé†’**ï¼ˆå³äºŒæ¬„ï¼‰- åˆä½œéŠ€è¡Œèˆ‡ LINE Pay å”èª¿
4. **è«‹æ¬¾è™•ç†**ï¼ˆæœ€å³æ¬„ï¼‰- å®Œæˆäº¤æ˜“

---

## âœ… ç¬¦åˆå°ˆæ¡ˆè¦æ ¼çš„éƒ¨åˆ†

### 1. è¨‚å–®å‰µå»ºæµç¨‹ï¼ˆä»˜æ¬¾è«‹æ±‚æ¬„ï¼‰

**æµç¨‹åœ–æ­¥é©Ÿï¼š**
- è³¼ç¥¨æ±ºå®š â†’ é™„æ¬¾è«‹æ±‚é€å‡ºè«‹æª¢æŸ¥

**ç¾æœ‰å¯¦ä½œï¼š**
- âœ… `OrderService.CreateOrderAsync` å·²å¯¦ä½œå®Œæ•´é©—è­‰é‚è¼¯
- âœ… åŒ…å«å ´æ¬¡é©—è­‰ã€åº§ä½æª¢æŸ¥ã€æ™‚åˆ»è¡¨ç‹€æ…‹é©—è­‰
- âœ… è‡ªå‹•è¨ˆç®—ç¥¨åƒ¹å’Œç¸½é‡‘é¡
- âœ… æ‰¹æ¬¡å‰µå»ºç¥¨åˆ¸è¨˜éŒ„

**å°æ‡‰ç¨‹å¼ç¢¼ä½ç½®ï¼š**
```
betterthanvieshow/Services/Implementations/OrderService.cs
- CreateOrderAsync (Line 40-162)
```

### 2. LINE Pay æˆæ¬Šæµç¨‹

**æµç¨‹åœ–æ­¥é©Ÿï¼š**
- LINE Payæˆæ¬Šï¼ˆä½¿ç”¨æŒå¡ç«¯æˆ–LINEé»æ•¸ï¼‰
- å•Ÿå‹•LINEè™›æ“¬ç”¨æˆ¶æˆ–LINEä½ˆå‡ºè«‹æª¢æŸ¥

**è¦æ ¼æŒ‡å®šï¼š**
- âœ… `è¨‚ç¥¨.feature` Line 63-64: "ç³»çµ±è·³è½‰åˆ° LINE Pay æ”¯ä»˜é é¢"
- âœ… `è¨‚ç¥¨.feature` Line 66-72: "LINE Pay æ”¯ä»˜å®Œæˆ"

### 3. è³‡æ–™åº«æ¬„ä½æº–å‚™

**å·²å®šç¾©æ¬„ä½ï¼š**
- âœ… `Order.PaymentTransactionId` - å„²å­˜ LINE Pay Transaction ID
- âœ… `Order.Status` - è¨‚å–®ç‹€æ…‹ï¼ˆPending/Paid/Cancelledï¼‰
- âœ… `Order.ExpiresAt` - ä»˜æ¬¾æœŸé™ï¼ˆ5åˆ†é˜ï¼‰
- âœ… `Ticket.Status` - ç¥¨åˆ¸ç‹€æ…‹ï¼ˆPending/Unused/Used/Expiredï¼‰

**å°æ‡‰ç¨‹å¼ç¢¼ä½ç½®ï¼š**
```
betterthanvieshow/Models/Entities/Order.cs
- PaymentTransactionId (Line 43)
- Status (Line 62)
- ExpiresAt (Line 55)
```

---

## âš ï¸ éœ€è¦èª¿æ•´èˆ‡æ–°å¢çš„éƒ¨åˆ†

### 1. è¨‚å–®ç‹€æ…‹æµè½‰é‚è¼¯

#### ç›®å‰ç‹€æ³
- âœ… å‰µå»ºè¨‚å–®æ™‚ï¼š`Status = "Pending"`ï¼ˆLine 97ï¼‰
- âŒ **ç¼ºå°‘ä»˜æ¬¾æˆåŠŸå¾Œçš„ç‹€æ…‹æ›´æ–°**

#### éœ€è¦å¯¦ä½œ
```csharp
// ä»˜æ¬¾æˆåŠŸå¾Œéœ€è¦æ›´æ–°
Order.Status = "Paid";
Order.PaymentTransactionId = linePayTransactionId;

// åŒæ™‚æ›´æ–°æ‰€æœ‰ç¥¨åˆ¸ç‹€æ…‹
foreach (var ticket in order.Tickets)
{
    ticket.Status = "Unused";
}
```

#### å°ˆæ¡ˆè¦æ ¼è¦æ±‚
æ ¹æ“š `erm.dbml` Line 83-84ï¼š
```
è¨‚å–®ç‹€æ…‹ï¼ˆä¸‰æ…‹è¨­è¨ˆï¼‰ï¼šæœªä»˜æ¬¾ â†’ å·²ä»˜æ¬¾ â†’ å·²å–æ¶ˆ
- è¨‚å–®å»ºç«‹å¾Œé€²å…¥ã€Œæœªä»˜æ¬¾ã€ç‹€æ…‹
- ä½¿ç”¨è€…å®Œæˆæ”¯ä»˜å¾Œè½‰ç‚ºã€Œå·²ä»˜æ¬¾ã€
- è¶…é 5 åˆ†é˜æœªä»˜æ¬¾æˆ–ä½¿ç”¨è€…å–æ¶ˆè¨‚å–®æ™‚è½‰ç‚ºã€Œå·²å–æ¶ˆã€
```

### 2. ç¥¨åˆ¸ç‹€æ…‹æµè½‰é‚è¼¯

#### ç›®å‰ç‹€æ³
- âœ… å‰µå»ºç¥¨åˆ¸æ™‚ï¼š`Status = "Pending"`ï¼ˆLine 115ï¼‰
- âŒ **ç¼ºå°‘æ”¯ä»˜æˆåŠŸå¾Œæ›´æ–°ç‚º "Unused"**

#### å°ˆæ¡ˆè¦æ ¼è¦æ±‚
æ ¹æ“š `erm.dbml` Line 97ï¼š
```
ç¥¨åˆ¸ç‹€æ…‹ï¼ˆå››æ…‹è¨­è¨ˆï¼‰ï¼šå¾…æ”¯ä»˜ â†’ æœªä½¿ç”¨ â†’ å·²ä½¿ç”¨ / å·²éæœŸ
- Pendingï¼ˆå¾…æ”¯ä»˜ï¼‰â†’ åº§ä½ç«‹å³é–å®š
- Unusedï¼ˆæœªä½¿ç”¨ï¼‰â†’ æ”¯ä»˜æˆåŠŸ
- Usedï¼ˆå·²ä½¿ç”¨ï¼‰â†’ æƒ QR code é©—ç¥¨æˆåŠŸ
- Expiredï¼ˆå·²éæœŸï¼‰â†’ 5 åˆ†é˜æœªä»˜æ¬¾æˆ–é›»å½±çµæŸæ™‚ï¼Œåº§ä½è‡ªå‹•é‡‹æ”¾
```

### 3. PaymentTransactionId è¨˜éŒ„

#### ç›®å‰ç‹€æ³
- âœ… è³‡æ–™åº«æ¬„ä½å·²å®šç¾©ï¼ˆLine 41-43ï¼‰
- âŒ **å‰µå»ºè¨‚å–®æ™‚æœªå¡«å…¥ï¼ˆé è¨­ç‚º nullï¼‰**

#### éœ€è¦å¯¦ä½œ
LINE Pay Confirm API å›å‚³çš„ `transactionId` éœ€è¦å„²å­˜è‡³æ­¤æ¬„ä½ï¼Œç”¨æ–¼ï¼š
- å°å¸³
- é€€æ¬¾è™•ç†ï¼ˆæœªä¾†åŠŸèƒ½ï¼‰
- äº¤æ˜“è¿½è¹¤

### 4. è‡ªå‹•éæœŸè¨‚å–®æ©Ÿåˆ¶

#### ç›®å‰ç‹€æ³
- âœ… `ExpiresAt` å·²è¨­å®šç‚ºå‰µå»ºæ™‚é–“ + 5åˆ†é˜ï¼ˆLine 96ï¼‰
- âŒ **ç¼ºå°‘èƒŒæ™¯ä»»å‹™è‡ªå‹•å–æ¶ˆéæœŸè¨‚å–®**

#### å°ˆæ¡ˆè¦æ ¼è¦æ±‚
æ ¹æ“š `è¨‚ç¥¨.feature` Line 74-79ï¼š
```gherkin
Rule: æœªä»˜æ¬¾è¨‚å–® 5 åˆ†é˜å¾Œè‡ªå‹•å–æ¶ˆ
  Example: è¶…æ™‚è‡ªå‹•å–æ¶ˆ
    Given Order å»ºç«‹æ™‚é–“ç‚ºã€Œ2025-12-20 14:00:00ã€
    When è‡³ã€Œ2025-12-20 14:05:01ã€ä»æœªå®Œæˆä»˜æ¬¾
    Then ç³»çµ±è‡ªå‹•å–æ¶ˆ Order
    And é‡‹æ”¾é ç•™åº§ä½
```

#### å¯¦ä½œæ–¹å¼
ä½¿ç”¨ `IHostedService` å¯¦ä½œèƒŒæ™¯æœå‹™ï¼š
```csharp
public class OrderExpirationService : BackgroundService
{
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        while (!stoppingToken.IsCancellationRequested)
        {
            // æ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡
            await CheckExpiredOrders();
            await Task.Delay(TimeSpan.FromMinutes(1), stoppingToken);
        }
    }
    
    private async Task CheckExpiredOrders()
    {
        // æ‰¾å‡ºæ‰€æœ‰éæœŸä¸”ç‹€æ…‹ç‚º Pending çš„è¨‚å–®
        // æ›´æ–° Order.Status = "Cancelled"
        // æ›´æ–° Ticket.Status = "Expired"
        // è§¸ç™¼ SignalR é€šçŸ¥åº§ä½é‡‹æ”¾
    }
}
```

---

## ğŸ¯ éœ€è¦æ–°å¢çš„åŠŸèƒ½

### 1. LINE Pay æ•´åˆ API

#### Request API - ç™¼èµ·ä»˜æ¬¾è«‹æ±‚

**API ç«¯é»ï¼š**
```
POST /api/payments/line-pay/request
```

**è«‹æ±‚å…§å®¹ï¼š**
```json
{
  "orderId": 123
}
```

**åŠŸèƒ½æè¿°ï¼š**
1. æŸ¥è©¢è¨‚å–®è³‡è¨Š
2. çµ„è£ LINE Pay Request API åƒæ•¸
3. å‘¼å« LINE Pay Request API
4. å›å‚³ä»˜æ¬¾ URL ä¾›å‰ç«¯è·³è½‰

**LINE Pay Request API è¦æ ¼ï¼š**
```http
POST https://sandbox-api-pay.line.me/v3/payments/request
Headers:
  Content-Type: application/json
  X-LINE-ChannelId: {Your Channel ID}
  X-LINE-ChannelSecret-Key: {Your Channel Secret}

Body:
{
  "amount": 1140,
  "currency": "TWD",
  "orderId": "#ABC-12345",
  "packages": [
    {
      "id": "1",
      "amount": 1140,
      "products": [
        {
          "name": "é›»å½±ç¥¨åˆ¸",
          "quantity": 3,
          "price": 380
        }
      ]
    }
  ],
  "redirectUrls": {
    "confirmUrl": "https://yourdomain.com/payments/confirm",
    "cancelUrl": "https://yourdomain.com/payments/cancel"
  }
}
```

**å›æ‡‰è™•ç†ï¼š**
```csharp
public class LinePayRequestResponseDto
{
    public string TransactionId { get; set; }  // å„²å­˜è‡³ Order.PaymentTransactionId
    public string PaymentUrl { get; set; }     // å›å‚³çµ¦å‰ç«¯é€²è¡Œè·³è½‰
}
```

#### Confirm API - ç¢ºèªä»˜æ¬¾å®Œæˆ

**API ç«¯é»ï¼š**
```
POST /api/payments/line-pay/confirm
```

**è«‹æ±‚å…§å®¹ï¼š**
```csharp
public class LinePayConfirmRequestDto
{
    public string TransactionId { get; set; }  // LINE Pay å›å‚³çš„ transactionId
    public int OrderId { get; set; }           // å…§éƒ¨è¨‚å–® ID
}
```

**åŠŸèƒ½æè¿°ï¼š**
1. å‘¼å« LINE Pay Confirm API
2. é©—è­‰ä»˜æ¬¾ç‹€æ…‹
3. æ›´æ–°è¨‚å–®ç‹€æ…‹ç‚º "Paid"
4. æ›´æ–°ç¥¨åˆ¸ç‹€æ…‹ç‚º "Unused"
5. å„²å­˜ PaymentTransactionId
6. ç”Ÿæˆ QR Code

**LINE Pay Confirm API è¦æ ¼ï¼š**
```http
POST https://sandbox-api-pay.line.me/v3/payments/{transactionId}/confirm
Headers:
  Content-Type: application/json
  X-LINE-ChannelId: {Your Channel ID}
  X-LINE-ChannelSecret-Key: {Your Channel Secret}

Body:
{
  "amount": 1140,
  "currency": "TWD"
}
```

#### Cancel Callback - è™•ç†ä½¿ç”¨è€…å–æ¶ˆ

**API ç«¯é»ï¼š**
```
GET /api/payments/line-pay/cancel
```

**åŠŸèƒ½æè¿°ï¼š**
- ä½¿ç”¨è€…åœ¨ LINE Pay é é¢é»æ“Šå–æ¶ˆæ™‚çš„å›å‘¼
- è¨˜éŒ„å–æ¶ˆäº‹ä»¶ï¼ˆå¯é¸ï¼‰
- è·³è½‰å›å‰ç«¯å–æ¶ˆé é¢

### 2. Payment Service æœå‹™å±¤

**æ–°å¢æª”æ¡ˆï¼š**
- `Services/Interfaces/IPaymentService.cs`
- `Services/Implementations/LinePayService.cs`

**æ ¸å¿ƒæ–¹æ³•ï¼š**
```csharp
public interface IPaymentService
{
    /// <summary>
    /// ç™¼èµ· LINE Pay ä»˜æ¬¾è«‹æ±‚
    /// </summary>
    Task<LinePayRequestResponseDto> CreatePaymentRequestAsync(int orderId);
    
    /// <summary>
    /// ç¢ºèª LINE Pay ä»˜æ¬¾å®Œæˆ
    /// </summary>
    Task<bool> ConfirmPaymentAsync(string transactionId, int orderId);
    
    /// <summary>
    /// è™•ç†ä»˜æ¬¾å–æ¶ˆ
    /// </summary>
    Task HandlePaymentCancelAsync(int orderId);
}
```

### 3. Payment Controller

**æ–°å¢æª”æ¡ˆï¼š**
- `Controllers/PaymentsController.cs`

**ç¯„ä¾‹ç¨‹å¼ç¢¼ï¼š**
```csharp
[ApiController]
[Route("api/payments")]
public class PaymentsController : ControllerBase
{
    private readonly IPaymentService _paymentService;
    
    [HttpPost("line-pay/request")]
    [Authorize]
    public async Task<IActionResult> RequestLinePayment([FromBody] PaymentRequestDto request)
    {
        var response = await _paymentService.CreatePaymentRequestAsync(request.OrderId);
        return Ok(response);
    }
    
    [HttpPost("line-pay/confirm")]
    public async Task<IActionResult> ConfirmLinePayment([FromQuery] string transactionId, [FromQuery] int orderId)
    {
        var success = await _paymentService.ConfirmPaymentAsync(transactionId, orderId);
        if (success)
        {
            return Ok(new { message = "ä»˜æ¬¾æˆåŠŸ" });
        }
        return BadRequest(new { message = "ä»˜æ¬¾å¤±æ•—" });
    }
    
    [HttpGet("line-pay/cancel")]
    public IActionResult CancelLinePayment([FromQuery] int orderId)
    {
        // è·³è½‰å›å‰ç«¯å–æ¶ˆé é¢
        return Redirect($"https://yourfrontend.com/payment-cancelled?orderId={orderId}");
    }
}
```

---

## ğŸ“‹ å¯¦ä½œå„ªå…ˆé †åº

### Phase 1: æ ¸å¿ƒä»˜æ¬¾æµç¨‹ï¼ˆé«˜å„ªå…ˆç´šï¼‰
1. âœ… **æ•´åˆ LINE Pay SDK**
   - å®‰è£ NuGet å¥—ä»¶æˆ–è‡ªè¡Œå°è£ HTTP Client
   - è¨­å®š Channel ID å’Œ Channel Secretï¼ˆå­˜æ”¾åœ¨ `appsettings.json`ï¼‰

2. âœ… **å¯¦ä½œ Request API**
   - å‰µå»º `LinePayService`
   - å¯¦ä½œ `CreatePaymentRequestAsync`
   - æ–°å¢ `POST /api/payments/line-pay/request` ç«¯é»

3. âœ… **å¯¦ä½œ Confirm API**
   - å¯¦ä½œ `ConfirmPaymentAsync`
   - æ›´æ–°è¨‚å–®å’Œç¥¨åˆ¸ç‹€æ…‹
   - æ–°å¢ `POST /api/payments/line-pay/confirm` ç«¯é»

4. âœ… **QR Code ç”Ÿæˆ**
   - ä»˜æ¬¾æˆåŠŸå¾Œç”Ÿæˆç¥¨åˆ¸ QR Code
   - å„²å­˜è‡³ `Ticket.QrCode` æ¬„ä½

### Phase 2: è‡ªå‹•åŒ–è™•ç†ï¼ˆä¸­å„ªå…ˆç´šï¼‰
5. âœ… **èƒŒæ™¯æœå‹™ - è¨‚å–®éæœŸè™•ç†**
   - å‰µå»º `OrderExpirationService : BackgroundService`
   - æ¯åˆ†é˜æƒæéæœŸè¨‚å–®
   - è‡ªå‹•å–æ¶ˆä¸¦é‡‹æ”¾åº§ä½
   - é€é SignalR é€šçŸ¥å‰ç«¯

6. âœ… **éŒ¯èª¤è™•ç†èˆ‡é‡è©¦æ©Ÿåˆ¶**
   - LINE Pay API å‘¼å«å¤±æ•—è™•ç†
   - ç¶²è·¯é€¾æ™‚é‡è©¦
   - ç•°å¸¸ç‹€æ…‹è¨˜éŒ„

### Phase 3: é€²éšåŠŸèƒ½ï¼ˆä½å„ªå…ˆç´šï¼‰
7. â­• **ä»˜æ¬¾è¨˜éŒ„æŸ¥è©¢**
   - ç®¡ç†å“¡æŸ¥è©¢æ‰€æœ‰ä»˜æ¬¾è¨˜éŒ„
   - ä½¿ç”¨è€…æŸ¥è©¢è‡ªå·±çš„ä»˜æ¬¾æ­·å²

8. â­• **å°å¸³åŠŸèƒ½**
   - ä½¿ç”¨ `PaymentTransactionId` é€²è¡Œå°å¸³
   - åŒ¯å‡ºäº¤æ˜“å ±è¡¨

9. â­• **é€€æ¬¾åŠŸèƒ½ï¼ˆæœªä¾†æ“´å……ï¼‰**
   - ç›®å‰è¦æ ¼ç„¡é€€ç¥¨åŠŸèƒ½
   - é ç•™ `PaymentTransactionId` ä¾›æœªä¾†ä½¿ç”¨

---

## ğŸ”§ è¨­å®šæª”æ¡ˆé…ç½®

### appsettings.json

```json
{
  "LinePay": {
    "ChannelId": "Your_Channel_ID",
    "ChannelSecret": "Your_Channel_Secret",
    "IsSandbox": true,
    "ApiBaseUrl": "https://sandbox-api-pay.line.me",
    "ConfirmUrl": "https://yourdomain.com/api/payments/line-pay/confirm",
    "CancelUrl": "https://yourdomain.com/api/payments/line-pay/cancel"
  }
}
```

### Program.cs è¨»å†Šæœå‹™

```csharp
// LINE Pay æœå‹™
builder.Services.AddScoped<IPaymentService, LinePayService>();

// èƒŒæ™¯æœå‹™ - è¨‚å–®éæœŸè™•ç†
builder.Services.AddHostedService<OrderExpirationService>();

// HTTP Client for LINE Pay API
builder.Services.AddHttpClient("LinePay", client =>
{
    var linePayConfig = builder.Configuration.GetSection("LinePay");
    client.BaseAddress = new Uri(linePayConfig["ApiBaseUrl"]);
    client.DefaultRequestHeaders.Add("X-LINE-ChannelId", linePayConfig["ChannelId"]);
    client.DefaultRequestHeaders.Add("X-LINE-ChannelSecret-Key", linePayConfig["ChannelSecret"]);
});
```

---

## ğŸ“Š å®Œæ•´æµç¨‹æ™‚åºåœ–

### ä»˜æ¬¾æˆåŠŸæµç¨‹

```
ä½¿ç”¨è€…              å‰ç«¯              å¾Œç«¯API           LINE Pay         
  |                 |                  |                 |                
  |-- é¸åº§ç¢ºèª ---->|                  |                 |                
  |                 |                  |                 |                
  |                 | POST /api/orders |                 |                
  |                 |----------------->|                 |                
  |                 |                  |-- å‰µå»ºè¨‚å–® ---->|  (å­˜å…¥DB)      
  |                 |                  |  Status:Pending |                
  |                 |                  |  åº§ä½é–å®š       |                
  |                 |<-----------------|                 |                
  |                 |  orderId: 123    |                 |                
  |                 |  orderNumber:    |                 |                
  |                 |  "#ABC-12345"    |                 |                
  |                 |                  |                 |                
  |                 | POST /api/payments/line-pay/request                
  |                 |----------------->|                 |                
  |                 |  { orderId:123 } |                 |                
  |                 |                  |                 |                
  |                 |                  | POST /v3/payments/request        
  |                 |                  |---------------->|                
  |                 |                  |  (å¸¶HMACç°½ç« )   |                
  |                 |                  |                 |                
  |                 |                  |<----------------|                
  |                 |                  |  paymentUrl     |                
  |                 |                  |  transactionId  |                
  |                 |<-----------------|                 |                
  |                 |  paymentUrl      |                 |                
  |                 |                  |                 |                
  |<-- è·³è½‰ LINE Pay|                  |                 |                
  |   (é–‹å•Ÿä»˜æ¬¾é )   |                  |                 |                
  |                 |                  |                 |                
  |   [åœ¨ LINE Pay é é¢æ“ä½œ]            |                 |                
  |                 |                  |                 |                
  |-- è¼¸å…¥å¯†ç¢¼ -----|------------------|---------------->|                
  |-- ç¢ºèªä»˜æ¬¾ -----|------------------|---------------->|               
  |                 |                  |   LINE Payè™•ç†   |                
  |                 |                  |                 |                
  |<-- è·³è½‰å›ä¾† ----|<-----------------|  Redirect to    |                
  | (ConfirmUrl +   |                  |   ConfirmUrl    |                
  |  transactionId) |                  |                 |                
  |                 |                  |                 |                
  |                 | POST /api/payments/line-pay/confirm                
  |                 |----------------->|                 |                
  |                 | { transactionId, |                 |                
  |                 |   orderId:123 }  |                 |                
  |                 |                  |                 |                
  |                 |                  | POST /v3/payments/{transactionId}/confirm
  |                 |                  |---------------->|                
  |                 |                  |  (å¸¶HMACç°½ç« )   |                
  |                 |                  |                 |                
  |                 |                  |<----------------|                
  |                 |                  |  returnCode:0000|                
  |                 |                  |                 |                
  |                 |                  |-- æ›´æ–°è¨‚å–® ---->|                
  |                 |                  |  Status: Paid   |                
  |                 |                  |-- æ›´æ–°ç¥¨åˆ¸ ---->|               
  |                 |                  |  Status: Unused |                
  |                 |                  |-- ç”Ÿæˆ QRCode ->|                
  |                 |                  |                 |                
  |                 |<-----------------|                 |                
  |                 |  ä»˜æ¬¾æˆåŠŸ        |                 |                
  |                 |  (ç¥¨åˆ¸+QRCode)   |                 |                
  |                 |                  |                 |                
  |<-- é¡¯ç¤ºç¥¨åˆ¸ ----|                  |                 |                
  | è¨‚å–®ç·¨è™Ÿ:        |                  |                 |                
  | #ABC-12345      |                  |                 |                
```

### ä»˜æ¬¾è¶…æ™‚æµç¨‹

```
å¾Œç«¯API           èƒŒæ™¯æœå‹™          è³‡æ–™åº«
  |                 |                 |
  |-- å‰µå»ºè¨‚å–® ---->|                 |
  |   ExpiresAt     |                 |
  |   = Now + 5min  |                 |
  |                 |                 |
  |            [ç­‰å¾… 5 åˆ†é˜]          |
  |                 |                 |
  |                 |-- æ¯åˆ†é˜æƒæ -->|
  |                 |<-- éæœŸè¨‚å–®åˆ—è¡¨ |
  |                 |                 |
  |                 |-- æ›´æ–°ç‹€æ…‹ ---->|
  |                 |   Order: Cancelled
  |                 |   Ticket: Expired
  |                 |                 |
  |                 |-- SignalR é€šçŸ¥åº§ä½é‡‹æ”¾ ->| å‰ç«¯
```

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡Œå‹•

### ç«‹å³å¯åŸ·è¡Œ
1. ç”³è«‹ LINE Pay æ¸¬è©¦å¸³è™Ÿï¼ˆSandboxï¼‰
2. å–å¾— Channel ID å’Œ Channel Secret
3. æ±ºå®šä½¿ç”¨å®˜æ–¹ SDK æˆ–è‡ªè¡Œå°è£ HTTP Client

### é–‹ç™¼éšæ®µ
1. å‰µå»º `LinePayService` å¯¦ä½œ Request/Confirm API
2. æ–°å¢ `PaymentsController` ç«¯é»
3. å¯¦ä½œè¨‚å–®ç‹€æ…‹æ›´æ–°é‚è¼¯
4. å‰µå»º `OrderExpirationService` èƒŒæ™¯æœå‹™

### æ¸¬è©¦éšæ®µ
1. ä½¿ç”¨ Sandbox ç’°å¢ƒæ¸¬è©¦å®Œæ•´ä»˜æ¬¾æµç¨‹
2. é©—è­‰è¨‚å–®ç‹€æ…‹æ­£ç¢ºè½‰æ›
3. æ¸¬è©¦ 5 åˆ†é˜è‡ªå‹•éæœŸæ©Ÿåˆ¶
4. æ¸¬è©¦åº§ä½é‡‹æ”¾èˆ‡ SignalR é€šçŸ¥

### ä¸Šç·šæº–å‚™
1. åˆ‡æ›è‡³ Production ç’°å¢ƒ
2. è¨­å®šæ­£å¼çš„ Confirm URL / Cancel URL
3. é€²è¡Œå£“åŠ›æ¸¬è©¦
4. æº–å‚™ç›£æ§èˆ‡ Log æ©Ÿåˆ¶

---

## ğŸ“š åƒè€ƒè³‡æº

- [LINE Pay API å®˜æ–¹æ–‡æª”](https://pay.line.me/tw/developers/apis/onlineApis?locale=zh_TW)
- å°ˆæ¡ˆè¦æ ¼ï¼š`docs/spec/erm.dbml`
- åŠŸèƒ½è¦æ ¼ï¼š`docs/spec/features/è¨‚ç¥¨.feature`
- ç¾æœ‰å¯¦ä½œï¼š`betterthanvieshow/Services/Implementations/OrderService.cs`

---

**æ–‡æª”ç‰ˆæœ¬ï¼š** v1.0  
**å»ºç«‹æ—¥æœŸï¼š** 2025-12-29  
**æœ€å¾Œæ›´æ–°ï¼š** 2025-12-29
