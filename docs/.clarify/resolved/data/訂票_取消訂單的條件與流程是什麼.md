# ✅ 釐清決議：訂票 - 取消訂單的條件與流程是什麼

**決議日期**：2025-12-11  
**決議狀態**：✅ 已完成  
**優先級**：High ⭐⭐

---

## 📌 決議內容

### 選擇方案
**方案 A — 簡單政策：未付款可取消，已付款不可取消（不支持退票）**

### 完整規則

#### 1. 取消訂單的條件

```
誰可以取消：
  ├─ 顧客：✅ 可取消自己的訂單（未付款狀態）
  ├─ 管理員：✅ 可取消任何訂單（未付款狀態）
  └─ 驗票員：❌ 無權取消

何時可取消：
  ├─ 未付款（awaiting_payment）：✅ 可取消
  ├─ 已付款（paid）：❌ 不可取消（不支持退票）
  └─ 已取消（cancelled）：❌ 無法重複取消
  
自動取消：
  └─ 未付款訂單 3 分鐘後自動過期並取消（由系統定時任務執行）
```

#### 2. 取消流程

```
手動取消流程（顧客發起）：

  顧客進入「我的訂票記錄」
    ↓
  選擇未付款訂單
    ↓
  點擊「取消訂單」按鈕
    ↓
  系統彈窗確認「確定要取消嗎？」
    ↓
  顧客確認
    ↓
  系統執行取消操作：
    ├─ 檢查 Order.status = 'awaiting_payment'
    ├─ 如果條件符合：
    │  ├─ 更新 Order.status = 'cancelled'
    │  ├─ 釋放所有 Ticket 對應的 Seat
    │  ├─ 更新 Ticket.status = 'expired'
    │  └─ 記錄取消日誌
    └─ 如果條件不符：
       └─ 返回錯誤：「訂單無法取消」
  ↓
  系統返回成功信息
    ↓
  從訂票記錄中移除該訂單（或標記為已取消）


管理員取消流程（同手動，但無需驗證所有權）：
  
  管理員進入「訂票管理」
    ↓
  查詢訂單（按訂單號、用戶等條件）
    ↓
  選擇未付款訂單
    ↓
  點擊「取消訂單」
    ↓
  系統確認此訂單為「未付款」
    ↓
  執行取消操作（同上）
    ↓
  記錄：「管理員 {admin_id} 於 {time} 取消訂單 {order_number}」


自動取消流程（系統定時執行）：

  系統定時任務（每 1 分鐘執行一次）：
    ├─ 查詢所有 awaiting_payment 狀態的訂單
    ├─ 檢查 Order.created_at + 3 分鐘 <= 當前時間
    ├─ 對於過期訂單：
    │  ├─ 更新 Order.status = 'cancelled'
    │  ├─ 更新所有 Ticket.status = 'expired'
    │  ├─ 釋放座位（更新 Seat 鎖定狀態）
    │  └─ 記錄自動取消日誌
    └─ 重複直到無過期訂單
```

#### 3. 取消後的狀態變化

```
取消前：
  Order.status = 'awaiting_payment'
  Ticket.status = 'awaiting_payment'
  Seat 被鎖定（被該訂單佔用）

取消後：
  ├─ Order.status = 'cancelled'（不可逆）
  ├─ Ticket.status = 'expired'（標記為過期）
  ├─ Seat 被釋放（回到可選狀態）
  └─ 座位可被其他用戶訂購
```

#### 4. 已付款訂單（無退票政策）

```
已付款訂單：
  Order.status = 'paid'
  
用戶嘗試取消：
  ├─ 系統檢查 Order.status != 'awaiting_payment'
  ├─ 返回錯誤信息：「已支付訂單無法取消，如有問題請聯絡客服」
  └─ 訂單保留不變
  
備註：
  後續若需支持退票，可升級為方案 B
  無需改動現有邏輯，直接擴展即可
```

---

## 🔧 實施影響

### 受影響的檔案

#### 1. **Feature 檔案** ✅ 待更新

```gherkin
Feature: 訂票 - 取消訂單
  Rule: 未付款訂單可取消
    Example: 顧客取消自己的未付款訂單
      Given 顧客有一筆未付款訂單
      When 顧客點擊「取消訂單」
      Then 訂單狀態變為「已取消」
      And 座位被釋放

    Example: 已付款訂單無法取消
      Given 訂單已支付
      When 顧客嘗試取消訂單
      Then 系統禁止操作
      And 提示「已支付訂單無法取消」

  Rule: 未付款訂單 3 分鐘後自動取消
    Example: 超時自動取消
      Given 訂單建立於 14:00:00
      When 時間推進至 14:03:01
      Then 系統自動取消該訂單
      And 座位被釋放
      And 發送通知給顧客
```

#### 2. **API 實施** ✅ 待實施

```javascript
// 手動取消訂單 API
async function cancelOrder(req, res) {
  const { order_id } = req.params;
  const current_user = req.user;
  
  try {
    // 1. 查詢訂單
    const order = await Order.findById(order_id);
    
    if (!order) {
      return res.status(404).json({ error: '訂單不存在' });
    }
    
    // 2. 驗證權限
    if (current_user.role === 'customer' && order.user_id !== current_user.id) {
      return res.status(403).json({ error: '無權取消他人訂單' });
    }
    
    // 3. 檢查訂單狀態
    if (order.status !== 'awaiting_payment') {
      return res.status(400).json({ 
        error: `訂單無法取消，當前狀態：${order.status}`,
        current_status: order.status
      });
    }
    
    // 4. 在事務中執行取消操作
    await sequelize.transaction(async (t) => {
      // 更新訂單狀態
      await order.update(
        { status: 'cancelled' },
        { transaction: t }
      );
      
      // 更新所有票券狀態
      await Ticket.update(
        { status: 'expired' },
        { where: { order_id: order_id }, transaction: t }
      );
      
      // 釋放座位（更新 Seat 的鎖定狀態）
      const tickets = await Ticket.findAll(
        { where: { order_id: order_id }, transaction: t }
      );
      
      for (const ticket of tickets) {
        // 座位鎖定邏輯取決於應用設計
        // 如果使用 Seat.locked_by_order_id，則清除
        // 或直接查詢時檢查是否有有效 Ticket
        await Seat.update(
          { locked_by_order_id: null },
          { where: { id: ticket.seat_id }, transaction: t }
        );
      }
      
      // 記錄取消日誌
      await CancellationLog.create({
        order_id: order_id,
        cancelled_by: current_user.id,
        cancelled_by_role: current_user.role,
        cancelled_at: new Date(),
        reason: 'manual_cancellation'
      }, { transaction: t });
    });
    
    // 5. 返回成功
    return res.json({
      success: true,
      message: '訂單已取消',
      order_number: order.order_number,
      refund_amount: order.total_price  // 注：本方案無實際退款
    });
    
  } catch (error) {
    return res.status(500).json({ error: error.message });
  }
}

// 自動取消過期訂單（定時任務）
async function autoCancelExpiredOrders() {
  const now = new Date();
  const expiredThreshold = new Date(now.getTime() - 3 * 60 * 1000); // 3 分鐘前
  
  try {
    const expiredOrders = await Order.findAll({
      where: {
        status: 'awaiting_payment',
        created_at: { [Op.lte]: expiredThreshold }
      }
    });
    
    for (const order of expiredOrders) {
      await sequelize.transaction(async (t) => {
        // 更新訂單
        await order.update({ status: 'cancelled' }, { transaction: t });
        
        // 更新票券
        await Ticket.update(
          { status: 'expired' },
          { where: { order_id: order.id }, transaction: t }
        );
        
        // 釋放座位
        const tickets = await Ticket.findAll({
          where: { order_id: order.id },
          transaction: t
        });
        
        for (const ticket of tickets) {
          await Seat.update(
            { locked_by_order_id: null },
            { where: { id: ticket.seat_id }, transaction: t }
          );
        }
        
        // 記錄自動取消
        await CancellationLog.create({
          order_id: order.id,
          cancelled_by: null,
          cancelled_by_role: 'system',
          cancelled_at: now,
          reason: 'timeout_expiration'
        }, { transaction: t });
        
        // 可選：發送通知給用戶
        sendNotification(order.user_id, 
          `您的訂單 ${order.order_number} 因未及時支付已自動取消，座位已釋放`
        );
      });
    }
    
    console.log(`[自動取消] 共取消 ${expiredOrders.length} 筆過期訂單`);
    
  } catch (error) {
    console.error('自動取消過期訂單失敗:', error);
  }
}

// 將 autoCancelExpiredOrders 設定為定時任務（每分鐘執行）
setInterval(autoCancelExpiredOrders, 60 * 1000);
```

#### 3. **前端實施** ✅ 待實施

```javascript
// 取消訂單按鈕
async function handleCancelOrder(orderId) {
  // 1. 確認彈窗
  const confirmed = confirm('確定要取消此訂單嗎？');
  if (!confirmed) return;
  
  try {
    // 2. 發送取消請求
    const response = await fetch(`/api/orders/${orderId}/cancel`, {
      method: 'POST'
    });
    
    if (!response.ok) {
      const error = await response.json();
      alert(`取消失敗：${error.error}`);
      return;
    }
    
    // 3. 成功
    const result = await response.json();
    alert('訂單已取消');
    
    // 4. 刷新頁面或移除該訂單
    location.reload();
    
  } catch (error) {
    alert(`錯誤：${error.message}`);
  }
}

// 顯示取消按鈕邏輯
function renderOrderRow(order) {
  let cancelButton = '';
  
  if (order.status === 'awaiting_payment') {
    // 未付款狀態才顯示取消按鈕
    cancelButton = `
      <button onclick="handleCancelOrder(${order.id})" class="btn-danger">
        取消訂單
      </button>
    `;
  } else if (order.status === 'paid') {
    // 已付款提示
    cancelButton = `<span class="text-muted">已支付，無法取消</span>`;
  } else if (order.status === 'cancelled') {
    // 已取消
    cancelButton = `<span class="text-secondary">已取消</span>`;
  }
  
  return `
    <tr>
      <td>${order.order_number}</td>
      <td>${order.status}</td>
      <td>${order.total_price}</td>
      <td>${cancelButton}</td>
    </tr>
  `;
}
```

---

## 🎯 設計理由

### 1. 簡化實現
- 未付款可取消，已付款不可取消，邏輯簡單
- 無需複雜的退款計算

### 2. 風險控制
- 防止已支付訂單的退款爭議
- 用戶支付前充分考慮

### 3. 符合 MVP 需求
- 支持核心功能（取消、釋放座位）
- 後續可升級至支持退票

### 4. 自動化取消
- 3 分鐘超時自動取消，無需手動干預
- 座位自動釋放，提高座位利用率

---

## ✅ 檢查清單

- [x] 決議文字版本創建
- [ ] Feature 檔案更新（下一步）
- [ ] API 取消邏輯實施（下一步）
- [ ] 定時任務設置（下一步）
- [ ] 前端 UI 實施（下一步）

---

**Phase 2 完成狀態**：✅ Item 1-4/8 完成

**下一個釐清項目**：`訂票_付款失敗時如何處理訂單與票券.md`

---

**文檔版本**：v1.0  
**最後更新**：2025-12-11  
**維護人員**：GitHub Copilot
