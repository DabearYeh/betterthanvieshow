# ✅ 釐清決議：Theater 減少座位總數時的座位刪除策略為何

**決議日期**：2025-12-11  
**決議狀態**：✅ 已完成  
**優先級**：High (Phase 1)

---

## 📌 決議內容

### 選擇方案
**選項 A — 禁止減少有訂票座位，等待自然過期或手動取消**

### 完整規則

#### 1. 座位刪除的基本原則

**禁止強制刪除有效訂票的座位**

```
減少座位總數時：
  
步驟 1：識別被刪除的座位（通常是末尾座位）
步驟 2：檢查這些座位是否有有效訂票
  SELECT COUNT(*) FROM Ticket
  WHERE seat_id IN (被刪除座位 ID)
  AND status IN ('待支付', '未使用', '已使用')

步驟 3：根據檢查結果決定
  
情況 A：被刪除座位無有效訂票
  ✅ 允許減少座位
  執行刪除操作
  更新 total_seats
  
情況 B：被刪除座位有有效訂票
  ❌ 拒絕減少座位
  提示管理員：「座位 F1-F10 仍有訂票記錄，無法刪除。
             請等待訂單過期或用戶取消後重試。」
```

#### 2. 管理員的可選方案

**若被刪除座位有訂票，管理員可選擇**：

| 方案 | 說明 | 操作 |
|------|------|------|
| **方案 1** | 等待訂單自動過期 | 無需操作，3 分鐘後未支付訂單自動取消 |
| **方案 2** | 等待訂單自然完成 | 等用戶驗票完成或電影結束，Ticket 變為已過期 |
| **方案 3** | 手動取消訂單 | 管理員進入訂單管理頁面，手動取消相關訂單 |
| **方案 4** | 保留座位配置 | 放棄減少座位，保持原有配置 |

**流程圖**：
```
管理員試圖減少座位
    ↓
系統檢查被刪除座位是否有訂票
    ↓
  有訂票 ──→ ❌ 拒絕
    ↓          ↓
   無訂票      提示管理員
    ↓          可選方案 1-4
  ✅ 允許     (等待過期/手動取消)
    ↓
  執行刪除
```

#### 3. 未來優化（非當前版本）

**後續可考慮的功能**：
```
方案 B：自動補償方案
  若管理員強制減少座位（需特殊權限）
  → 系統自動取消相關訂票
  → 自動退款或積分補償
  → 通知用戶

方案 C：座位轉移方案
  若要減少座位
  → 系統自動將座位 F1-F10 的訂票轉移到其他座位
  → 需用戶確認
  （複雜度高，暫不實現）
```

---

## 📝 設計理由

### 1. 保護用戶權益
- 已訂票的座位不被強制刪除
- 用戶訂票記錄和權益受保護

### 2. 簡化系統邏輯
- 無需實現複雜的座位轉移邏輯
- 無需自動退款和補償機制
- 減少邊界情況的處理

### 3. 降低風險
- 避免因座位刪除導致的訂票衝突
- 避免誤刪已訂座位的情況

### 4. 管理員掌控
- 給管理員充分的選擇權
- 無需強制取消用戶訂票
- 保留數據完整性

### 5. 與 Item 7 一致
- 與「座位網格配置決議」邏輯一致
- 禁止減少有訂票座位，強化座位數據安全

---

## 🔧 實施影響

### 受影響的規格檔案

1. **`spec/erm.dbml`** ✅ 無需修改
   - Theater 和 Seat 的邏輯已在 Item 7 定義

2. **Feature 檔案**（待檢查）
   - `編輯影廳.feature` — 新增規則：減少座位時檢查訂票，禁止刪除有訂票座位
   - 新增 Error Case：「座位仍有訂票，無法刪除」

3. **API/實施文件**（待實施）
   - 編輯影廳 API：減少座位時的檢查邏輯
   - 返回錯誤信息：「座位 {座位列表} 仍有訂票記錄」
   - 支持管理員查詢「哪些座位有訂票」

4. **管理後臺功能**（待實施）
   - 編輯影廳頁面：
     - 顯示「無法減少座位，以下座位仍有訂票」
     - 提供「查看相關訂票」按鈕
     - 提供「手動取消訂票」快捷方案
   - 訂票管理頁面：支持按座位篩選和取消

5. **數據庫檢查邏輯**
   ```sql
   -- 檢查被刪除座位是否有有效訂票
   SELECT s.id, s.row_name, s.column_number, COUNT(t.id) as ticket_count
   FROM Seat s
   LEFT JOIN Ticket t ON s.id = t.seat_id 
                      AND t.status IN ('待支付', '未使用', '已使用')
   WHERE s.theater_id = ? 
   AND s.row_name IN (被刪除的排)  -- 或其他被刪除的座位條件
   GROUP BY s.id
   HAVING COUNT(t.id) > 0
   ```

---

## 💡 後續相關決議

- **訂單管理功能**（Phase 2）— 支持管理員查詢和取消訂票
- **座位轉移方案**（Phase 3 或更後期）— 若需要支持座位縮減 + 用戶補償

---

## ✅ 檢查清單

- [x] 決議文字版本創建
- [ ] Feature 檔案驗證（下一步）
- [ ] 管理後臺 UI 設計（下一步）
- [ ] API 錯誤提示邏輯實現（下一步）

---

**下一個釐清項目**：`User_密碼複雜度具體要求為何.md`
