# ✅ 釐清決議：瀏覽電影 - 正在上映與即將上映的判斷邏輯為何

**決議日期**：2025-12-11  
**決議狀態**：✅ 已完成  
**優先級**：High ⭐

---

## 📌 決議內容

### 核心規則
**Movie 狀態動態計算，基於 release_date 和 end_date 與當前日期的比較**

### 完整邏輯

#### 1. 三種上映狀態定義

```
Movie.status 自動計算（無需 is_published 欄位）：

狀態 1️⃣：即將上映（coming_soon）
  條件：release_date > 今天
  說明：電影尚未上映，將在未來放映
  可排片：❌ 不可排片（因為沒有上映日期的場次）
  可訂票：❌ 無法訂票（無場次可選）
  
狀態 2️⃣：正在上映（showing）
  條件：release_date ≤ 今天 ≤ end_date
  說明：電影在上映期間（首日至末日，含兩端）
  可排片：✅ 可排片（在此區間內的任何日期）
  可訂票：✅ 可訂票
  
狀態 3️⃣：已下映（ended）
  條件：end_date < 今天
  說明：電影已下映，不再放映
  可排片：❌ 不可排片
  可訂票：❌ 無法訂票
```

#### 2. 邊界條件澄清

```
end_date 的含義：
  end_date = 電影的「最後放映日期」
  
  ✅ 包含 end_date 當天
  ✅ end_date 當天仍可排片和訂票
  ❌ end_date 的隔天開始無法訂票

範例（今天 = 2025-12-11）：

  電影 A：release_date = 2025-12-11, end_date = 2025-12-31
  → release_date (12-11) ≤ 今天 (12-11) ≤ end_date (12-31) ✅
  → 狀態：正在上映
  → 今天可訂票 ✅

  電影 B：release_date = 2025-12-12, end_date = 2026-01-15
  → release_date (12-12) > 今天 (12-11) ✅
  → 狀態：即將上映
  → 今天無法訂票 ❌

  電影 C：release_date = 2025-12-10, end_date = 2025-12-11
  → release_date (12-10) ≤ 今天 (12-11) ≤ end_date (12-11) ✅
  → 狀態：正在上映（最後一天）
  → 今天可訂票 ✅（最後一次機會）

  電影 D：release_date = 2025-12-10, end_date = 2025-12-10
  → release_date (12-10) ≤ 今天 (12-11)？ ✅
  → 今天 (12-11) ≤ end_date (12-10)？ ❌
  → 狀態：已下映
  → 今天無法訂票 ❌
```

#### 3. 計算公式

```
SQL 實現：

CASE 
  WHEN release_date > CURDATE() THEN 'coming_soon'
  WHEN release_date <= CURDATE() AND end_date >= CURDATE() THEN 'showing'
  ELSE 'ended'
END AS status

JavaScript 實現：

function getMovieStatus(releaseDate, endDate) {
  const today = new Date();
  today.setHours(0, 0, 0, 0); // 重置時間為 00:00:00
  
  if (new Date(releaseDate) > today) {
    return 'coming_soon';
  } else if (new Date(releaseDate) <= today && new Date(endDate) >= today) {
    return 'showing';
  } else {
    return 'ended';
  }
}
```

#### 4. 前端顯示邏輯

```
瀏覽電影列表時：

正在上映電影：
  ├─ 顯示在「現正上映」分類
  ├─ 顯示「立即訂票」按鈕
  └─ 顯示下映日期提示（如「12 月 31 日下映」）

即將上映電影：
  ├─ 顯示在「即將上映」分類
  ├─ 顯示「預告」按鈕（不可訂票）
  └─ 顯示上映日期（如「12 月 12 日上映」）

已下映電影：
  ├─ 不顯示在列表中（或灰顯）
  ├─ 無訂票按鈕
  └─ 顯示「已下映」標籤

搜尋和篩選：
  ├─ 默認只顯示「正在上映」
  ├─ 可選擇顯示「即將上映」
  └─ 不顯示「已下映」（除非特別篩選）
```

#### 5. 排片限制

```
電影管理員排片時的限制：

Rule: 電影排片日期必須在 [release_date, end_date] 範圍內

Example 1: 可以排片
  Movie.release_date = 2025-12-11
  Movie.end_date = 2025-12-31
  show_date = 2025-12-15
  
  檢查：2025-12-11 ≤ 2025-12-15 ≤ 2025-12-31 ✅
  結果：允許排片

Example 2: 不可以排片（超出範圍）
  Movie.release_date = 2025-12-20
  Movie.end_date = 2025-12-31
  show_date = 2025-12-15
  
  檢查：2025-12-20 ≤ 2025-12-15？ ❌
  結果：拒絕排片（電影未上映）

Example 3: 不可以排片（已下映）
  Movie.release_date = 2025-12-01
  Movie.end_date = 2025-12-10
  show_date = 2025-12-15
  
  檢查：2025-12-15 ≤ 2025-12-10？ ❌
  結果：拒絕排片（電影已下映）
```

---

## 🔧 實施影響

#### 1. **spec/erm.dbml** ✅ 確認欄位

```sql
Table Movie {
  ...
  release_date Date [not null, note: '上映開始日期']
  end_date Date [not null, note: '上映結束日期（最後放映日，包含當天）']
  ...
  // ❌ 無需 is_published 或 release_status 欄位
  // ✅ status 由應用層動態計算
}
```

#### 2. **API 實施** ✅

```javascript
// 獲取電影列表（含狀態篩選）
async function getMovies(req, res) {
  const { status_filter } = req.query; // 'showing', 'coming_soon', 或不指定（默認顯示 showing）
  
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  let where = {};
  
  if (status_filter === 'coming_soon') {
    // 即將上映
    where = { release_date: { [Op.gt]: today } };
  } else if (status_filter === 'ended') {
    // 已下映
    where = { end_date: { [Op.lt]: today } };
  } else {
    // 默認：正在上映
    where = {
      release_date: { [Op.lte]: today },
      end_date: { [Op.gte]: today }
    };
  }
  
  const movies = await Movie.findAll({ where });
  
  // 為每部電影計算狀態（冗餘，但便於前端使用）
  const moviesWithStatus = movies.map(movie => ({
    ...movie.toJSON(),
    status: calculateMovieStatus(movie.release_date, movie.end_date, today)
  }));
  
  return res.json(moviesWithStatus);
}

// 計算單部電影的狀態
function calculateMovieStatus(releaseDate, endDate, today) {
  const rel = new Date(releaseDate);
  const end = new Date(endDate);
  rel.setHours(0, 0, 0, 0);
  end.setHours(0, 0, 0, 0);
  
  if (rel > today) {
    return 'coming_soon';
  } else if (rel <= today && end >= today) {
    return 'showing';
  } else {
    return 'ended';
  }
}

// 排片時的日期驗證
async function validateShowDateForMovie(movieId, showDate) {
  const movie = await Movie.findById(movieId);
  
  const rel = new Date(movie.release_date);
  const end = new Date(movie.end_date);
  const show = new Date(showDate);
  
  rel.setHours(0, 0, 0, 0);
  end.setHours(0, 0, 0, 0);
  show.setHours(0, 0, 0, 0);
  
  if (show < rel) {
    throw new Error(`電影未上映，無法排片（上映日期：${movie.release_date}）`);
  }
  
  if (show > end) {
    throw new Error(`電影已下映，無法排片（下映日期：${movie.end_date}）`);
  }
  
  return true; // 驗證通過
}
```

#### 3. **前端實施** ✅

```javascript
// 電影列表頁面
async function loadMovies() {
  try {
    // 1. 獲取正在上映的電影（默認）
    const showingMovies = await fetch('/api/movies?status_filter=showing').then(r => r.json());
    renderMovieList(showingMovies, '現正上映');
    
    // 2. 獲取即將上映的電影
    const comingSoonMovies = await fetch('/api/movies?status_filter=coming_soon').then(r => r.json());
    renderMovieList(comingSoonMovies, '即將上映');
    
  } catch (error) {
    console.error('加載電影列表失敗:', error);
  }
}

// 渲染電影卡片
function renderMovieCard(movie) {
  let actionButton = '';
  let statusBadge = '';
  
  if (movie.status === 'showing') {
    actionButton = `<button class="btn btn-primary" onclick="bookTicket(${movie.id})">立即訂票</button>`;
    statusBadge = `<span class="badge bg-success">現正上映</span>`;
  } else if (movie.status === 'coming_soon') {
    actionButton = `<button class="btn btn-secondary" disabled>預告</button>`;
    statusBadge = `<span class="badge bg-info">即將上映</span>`;
  } else if (movie.status === 'ended') {
    statusBadge = `<span class="badge bg-secondary">已下映</span>`;
  }
  
  return `
    <div class="movie-card">
      <h3>${movie.title}</h3>
      <img src="${movie.poster_url}" />
      ${statusBadge}
      <p>上映期間：${movie.release_date} ~ ${movie.end_date}</p>
      ${actionButton}
    </div>
  `;
}
```

---

## 🎯 設計理由

### 1. 符合現實
- end_date 是最後放映日，用戶直觀理解
- 與電影院運營慣例一致

### 2. 簡化邏輯
- 無需 is_published 或 release_status 欄位
- 狀態完全由日期決定，無冗餘數據

### 3. 自動化
- 日期到期自動變更狀態，無需手動維護
- 跨時區友好（基於日期，不涉及時間）

### 4. 靈活排片
- 電影可在整個上映期間內任何日期排片
- 便於檔期調整和重新排片

---

## ✅ 檢查清單

- [x] 決議文字版本創建
- [ ] spec/erm.dbml 確認欄位（下一步）
- [ ] API 狀態計算邏輯實施（下一步）
- [ ] 前端篩選和顯示實施（下一步）
- [ ] 排片日期驗證實施（下一步）

---

**Phase 2 完成狀態**：✅ Item 1-6/8 完成

**下一個釐清項目**：`驗票_驗票人員身份如何識別與驗證.md`

---

**文檔版本**：v1.0  
**最後更新**：2025-12-11  
**維護人員**：GitHub Copilot
