# 釐清問題

訂單的完整狀態轉換流程是什麼？（規格中提到：待付款、已付款、已完成、已取消、已退款）何時觸發各狀態轉換？

# 定位

ERM：Order.order_status 屬性（值為：待付款、已付款、已完成、已取消、已退款）

# 多選題

| 選項 | 描述 |
|--------|-------------|
| A | 線性：待付款 → 已付款 → 已完成；或任何狀態可取消 → 已取消；或已退款 |
| B | 支付流程：待付款 → 已付款；已驗證 → 已完成；若驗票後取消 → 已退款 |
| C | 複雜狀態機：支持多個轉換路徑與條件 |
| Short | 具體狀態轉換規則 |

# 影響範圍

- Order 實體的生命週期管理
- 訂票功能的支付流程
- 驗票與入場流程
- 退款與取消流程的設計

# 優先級

High

---

**說明**：規格中 Order 列出了 5 個狀態，但未清楚定義何時進入各狀態、轉換條件、以及「已完成」的精確定義（是驗票後？還是場次結束？）。

---
# 解決記錄

- **回答**：A - 確認三態設計（未付款→已付款→已取消）
- **更新的規格檔**：無需修改（當前設計已符合需求）
- **變更內容**：
  - 決策：Order 狀態為三態設計 - 未付款 → 已付款 → 已取消
  - 狀態轉換規則：
    - **未付款**：訂單建立後的初始狀態，開始 3 分鐘倒數
    - **已付款**：使用者完成 LINE Pay 支付後轉為此狀態
    - **已取消**：超過 3 分鐘未付款、支付失敗、或使用者主動取消時轉為此狀態
  - 重要決策：訂單不會被刪除，「已取消」狀態的訂單保留在資料庫中用於稽核和分析
  - 座位管理：未付款/已付款 = 座位鎖定；已取消 = 座位釋放
  - 當前 erm.dbml 中 Order.status 的定義已完整描述此三態設計，符合此決策
