# 電影院訂票系統 - 規格釐清總覽

## 1. 釐清項目統計

- **資料模型相關**：14 項
  - User: 1 項
  - Movie: 2 項
  - Theater: 2 項
  - MovieShowTime: 1 項
  - Ticket: 3 項
  - Order: 3 項
  - Cinema: 1 項
  - TicketValidateLog: 1 項

- **功能模型相關**：37 項
  - 訂票：11 項
  - 驗票：4 項
  - 查詢訂票記錄：3 項
  - 瀏覽電影：2 項
  - 瀏覽場次：2 項
  - 設定座位配置：3 項
  - 設定場次：3 項
  - 編輯影廳：1 項
  - 刪除影廳：1 項
  - 刪除電影：1 項
  - 使用者認證相關：3 項
  - 其他：2 項

- **總計**：51 項

## 2. 優先級分佈

**註**：根據新掃描結果，以下為初步優先級統計（具體優先級依各釐清項目檔案定義）

- **High 優先級**：約 20 項（影響核心功能與資料結構）
- **Medium 優先級**：約 25 項（影響邊界條件與特定功能）
- **Low 優先級**：約 6 項（優化與細節調整）

## 3. 建議釐清順序

### 第一階段：核心資料模型（High 優先級，共約 8 項）

此階段專注於確保核心實體與屬性的完整定義，這些決策將影響所有後續功能設計。

**核心實體釐清項目**：
- `User_密碼複雜度具體要求為何.md` - 使用者認證安全性
- `Cinema_多影城支援的具體範圍為何.md` - 整體架構影響（**優先**）
- `Movie_上映狀態轉換規則為何.md` - 電影生命週期
- `Order_訂單狀態完整轉換規則為何.md` - 訂票流程核心（**優先**）
- `Ticket_狀態轉換的完整流程是什麼.md` - 票券生命週期（**優先**）
- `Theater_修改座位總數時的座位自動編號規則為何.md` - 影廳管理邏輯
- `Theater_減少座位總數時的座位刪除策略為何.md` - 影廳管理邏輯
- `MovieShowTime_與Movie時長的關係如何驗證.md` - 場次排程邏輯

### 第二階段：核心功能規則（High 優先級功能，共約 8 項）

此階段確保主要業務流程（訂票、驗票、使用者管理）的規則完整性。

**核心功能釐清項目**：
- `使用者認證_使用者角色與權限劃分為何.md` - 全系統權限基礎（**優先**）
- `訂票_取消訂單的條件與流程是什麼.md` - 訂票流程完整性
- `訂票_original_price和final_price的計算邏輯.md` - 價格計算邏輯（**優先**）
- `訂票_Order的total_amount如何從Ticket計算.md` - 訂單金額計算
- `訂票_付款失敗時如何處理訂單與票券.md` - 支付失敗流程
- `查詢訂票記錄_查詢功能的訪問權限為何.md` - 權限控制
- `驗票_驗票人員身份如何識別與驗證.md` - 驗票人員管理
- `瀏覽電影_正在上映與即將上映的判斷邏輯為何.md` - 電影篩選邏輯

### 第三階段：邊界條件與跨模型互動（Medium 優先級，共約 25 項）

此階段補充第一、二階段未覆蓋的邊界情況與特殊場景。

**邊界條件釐清項目**（優先順序遞減）：
- `Order_支付失敗時座位鎖定多久會被釋放.md` - 座位管理策略
- `Ticket_已過期狀態自動更新還是手動標記.md` - 票券狀態管理
- `Movie_電影時長是否有上限限制.md` - 數據驗證規則
- `查詢訂票記錄_feature的規則與examples過於簡略.md` - 功能規則補充
- `訂票_選擇座位時如何判斷座位是否已被訂走.md` - 座位占用判斷
- `訂票_一次訂單可以訂購多張票嗎.md` - 批量購票支援
- `訂票_確認訂單後付款的流程為何.md` - 支付流程明確化
- `驗票_如何判斷票券是否過期.md` - 過期判斷邏輯
- `驗票_驗證成功後如何登記為已入場.md` - 驗票結果記錄
- `設定場次_同一影廳同一時段的衝突判斷邏輯為何.md` - 時間衝突檢查
- `瀏覽電影_未登入使用者是否可以瀏覽.md` - 訪問權限
- `設定座位配置_座位的seat_type如何設定.md` - 座位類型定義
- `設定場次_場次時間設定的最小粒度為何.md` - 時間精度設定
- `設定場次_場次跨越午夜或跨日期的處理方式.md` - 跨日期場次處理
- 其他 Medium 優先級項目...

### 第四階段：細節與優化（Low 優先級，共約 6 項）

此階段處理剩餘的低優先級項目，可在上面三個階段完成後進行。

- `訂票_座位選擇的最小購買單位是什麼.md` - 商業模型細節
- `瀏覽場次_場次資訊的展示顆粒度為何.md` - UX 細節
- `訂票_單次訂單可購買的最大票數是否有限制.md` - 購票限制
- 其他 Low 優先級項目...

## 4. 釐清策略說明

### 平衡原則

- **第一階段**：聚焦資料模型，建立清晰的實體定義與狀態機制
  - 時間估計：3-5 個工作天
  - 檢查點：確保所有核心實體的狀態轉換規則明確

- **第二階段**：聚焦功能模型，確保業務流程的規則完整性
  - 時間估計：3-5 個工作天
  - 依賴：必須完成第一階段
  - 檢查點：確保訂票、驗票、使用者管理的主流程清晰

- **第三階段**：交替進行資料與功能的邊界情況補充
  - 時間估計：5-7 個工作天
  - 依賴：可與第二階段並行
  - 檢查點：邊界 example 完整性

- **第四階段**：收尾細節，優化使用者體驗與系統設計
  - 時間估計：2-3 個工作天
  - 檢查點：所有釐清項目均已解決

### 依賴關係說明

```
第一階段（資料模型基礎）
    ├─ User 密碼規則
    ├─ Cinema 多影城
    ├─ Movie 狀態轉換
    ├─ Order 狀態轉換 ★
    ├─ Ticket 狀態轉換 ★
    ├─ Theater 座位編號與刪除
    └─ MovieShowTime 時長驗證
        ↓
第二階段（功能規則確立） ★ = 關鍵依賴
    ├─ 使用者角色權限 ★
    ├─ 訂票流程與取消
    ├─ 價格計算邏輯 ★
    ├─ 支付失敗處理
    ├─ 查詢與驗票
    └─ 電影篩選
        ↓ 並行進行
第三階段（邊界條件補充）
    ├─ 座位鎖定時限
    ├─ 票券過期管理
    ├─ 時間精度與衝突
    ├─ 其他邊界條件
    └─ 功能規則補充
        ↓
第四階段（細節優化）
```

### 高影響釐清項目（需優先確認）

這些項目的決策會直接影響多個相關功能與實體：

1. **多影城支援範圍**（Cinema 實體）
   - 影響：整體架構、影廳管理、場次管理、使用者流程
   - 建議提前與業務確認

2. **使用者角色與權限**（全系統）
   - 影響：所有功能的權限檢查、API 設計、前台導航
   - 建議於第二階段最早確認

3. **訂單與票券狀態機制**（Order + Ticket）
   - 影響：訂票、支付、驗票、退款、查詢功能
   - 建議第一階段重點處理

4. **票價計算邏輯**（Ticket price + Order total_amount）
   - 影響：訂票結算、支付驗證、報表統計
   - 建議於第二階段提前釐清

## 5. 覆蓋度摘要

### 資料模型（A1-A6）

| 檢查項 | 狀態 | 釐清項目數 | 說明 |
|--------|------|----------|------|
| A1. 實體完整性 | **Clear** | 0 | 9 個主要實體清楚定義 |
| A2. 屬性定義 | **Partial** | 3 | 大多數屬性定義清楚，但部分缺乏衍生公式 |
| A3. 屬性值邊界條件 | **Partial** | 4 | 部分屬性有邊界檢查，但不完整 |
| A4. 跨屬性不變條件 | **Partial** | 3 | 定義了部分跨屬性條件，但部分關係未明確 |
| A5. 關係與唯一性 | **Clear** | 0 | 外鍵關聯與主鍵清楚定義 |
| A6. 生命週期與狀態 | **Partial** | 4 | 定義了狀態值，但轉換規則不完整 |

**資料模型釐清項目數**：14 項

### 功能模型（B1-B5）

| 檢查項 | 狀態 | 釐清項目數 | 說明 |
|--------|------|----------|------|
| B1. 功能識別 | **Clear** | 0 | 16 個功能清楚識別 |
| B2. 規則完整性 | **Partial** | 15 | 大多數功能有多條規則，部分缺乏邊界情況 |
| B3. 例子覆蓋度 | **Partial** | 8 | 大多數規則有 example，但部分缺乏邊界 example |
| B4. 邊界條件覆蓋 | **Missing** | 10 | 缺乏系統性的邊界條件測試 case |
| B5. 錯誤與異常處理 | **Partial** | 4 | 部分功能定義了異常處理，但不完整 |

**功能模型釐清項目數**：37 項

### 術語與一致性（C1-C2）

| 檢查項 | 狀態 | 說明 |
|--------|------|------|
| C1. 詞彙表 | **Clear** | 核心術語使用一致（電影、影廳、場次、票券、訂單等） |
| C2. 術語衝突 | **Clear** | 未發現同義詞混用或同名異義問題 |

### 其他品質檢查（D1-D2）

| 檢查項 | 狀態 | 說明 |
|--------|------|------|
| D1. 待決事項 | **Partial** | 存在隱含的設計決策未明確 |
| D2. 模糊描述 | **Partial** | 存在模糊的時間描述但不顯著 |

## 6. 釐清項目檔案索引

### 資料模型釐清項目（`.clarify/data/` 目錄）

1. `Cinema_多影城支援的具體範圍為何.md` ⭐ **High Priority**
2. `Movie_上映狀態轉換規則為何.md` ⭐ **High Priority**
3. `Movie_電影時長是否有上限限制.md` - Medium Priority
4. `MovieShowTime_與Movie時長的關係如何驗證.md` ⭐ **High Priority**
5. `Order_訂單狀態完整轉換規則為何.md` ⭐ **High Priority**
6. `Order_order_status屬性的完整狀態轉換.md`
7. `Order_支付失敗時座位鎖定多久會被釋放.md` - Medium Priority
8. `Ticket_狀態轉換的完整流程是什麼.md` ⭐ **High Priority**
9. `Ticket_status屬性的所有可能值為何.md` - Medium Priority
10. `Ticket_已過期狀態自動更新還是手動標記.md` - Medium Priority
11. `Theater_修改座位總數時的座位自動編號規則為何.md` ⭐ **High Priority**
12. `Theater_減少座位總數時的座位刪除策略為何.md` ⭐ **High Priority**
13. `TicketValidateLog_何時建立與必要資訊.md` - Medium Priority
14. `User_密碼複雜度具體要求為何.md` ⭐ **High Priority**

### 功能模型釐清項目（`.clarify/features/` 目錄）

**訂票相關**（11 項）：
- `訂票_取消訂單的條件與流程是什麼.md` ⭐ **High Priority**
- `訂票_original_price和final_price的計算邏輯.md` ⭐ **High Priority**
- `訂票_Order的total_amount如何從Ticket計算.md` ⭐ **High Priority**
- `訂票_何時更新Order狀態為已完成.md` - High Priority
- `訂票_付款失敗時如何處理訂單與票券.md` - High Priority
- `訂票_確認訂單後付款的流程為何.md` - High Priority
- `訂票_選擇座位時如何判斷座位是否已被訂走.md` - High Priority
- `訂票_一次訂單可以訂購多張票嗎.md` - High Priority
- `訂票_單次訂單可購買的最大票數是否有限制.md` - Medium Priority
- `訂票_座位選擇的最小購買單位是什麼.md` - Low Priority
- `訂票_是否有訂票數量限制.md` - Medium Priority
- `訂票_訂票前使用者狀態要求.md` - Medium Priority

**驗票相關**（4 項）：
- `驗票_驗票人員身份如何識別與驗證.md` ⭐ **High Priority**
- `驗票_如何判斷票券是否過期.md` - High Priority
- `驗票_驗證成功後如何登記為已入場.md` - High Priority
- `驗票_驗票失敗時是否需要記錄失敗原因.md` - Medium Priority

**查詢相關**（3 項）：
- `查詢訂票記錄_查詢功能的訪問權限為何.md` - High Priority
- `查詢訂票記錄_可以透過哪些條件查詢.md` - Medium Priority
- `查詢訂票記錄_feature的規則與examples過於簡略.md` - High Priority

**瀏覽相關**（4 項）：
- `瀏覽電影_正在上映與即將上映的判斷邏輯為何.md` - High Priority
- `瀏覽電影_未登入使用者是否可以瀏覽.md` - Medium Priority
- `瀏覽場次_場次資訊的展示顆粒度為何.md` - Low Priority
- `瀏覽場次_如何篩選與顯示場次.md` - Medium Priority

**設定相關**（6 項）：
- `設定座位配置_座位的seat_type如何設定.md` - Medium Priority
- `設定座位配置_現有座位修改的規則為何.md` - Medium Priority
- `設定座位配置_配置模式選擇.md` - Medium Priority
- `設定場次_同一影廳同一時段的衝突判斷邏輯為何.md` - High Priority
- `設定場次_場次時間設定的最小粒度為何.md` - Medium Priority
- `設定場次_場次跨越午夜或跨日期的處理方式.md` - Medium Priority

**編輯/刪除相關**（3 項）：
- `編輯影廳_修改座位總數時的同步策略為何.md` - High Priority
- `刪除影廳_若影廳有已排程的場次是否可以刪除.md` - High Priority
- `刪除電影_若電影有已排程的場次是否可以刪除.md` - High Priority
- `編輯電影_若電影已有場次修改資訊是否有限制.md` - Medium Priority

**使用者認證相關**（3 項）：
- `使用者認證_使用者角色與權限劃分為何.md` ⭐ **High Priority**
- `使用者登入_登入流程與驗證.md` - Medium Priority
- `使用者登出_登出流程.md` - Low Priority
- `使用者註冊_註冊流程與規則.md` - Medium Priority

## 7. 後續行動

### 即時行動

1. **執行釐清互動**（使用 `formulation.md` prompt）
   - 按照上述 4 個階段順序進行
   - 優先處理帶 ⭐ 標記的 High Priority 項目
   - 在第一階段完成後進行檢查點

2. **文件更新**
   - 每當一個釐清項目得到答案，將其從 `.clarify/` 移至 `.clarify/resolved/`
   - 更新 `.clarify/overview.md` 的完成進度
   - 在 `spec/erm.dbml` 或 `spec/features/*.feature` 中同步更新規格

### 風險識別

- **架構風險**：多影城決策會影響整體設計，建議最早確認
- **功能複雜性**：訂票流程涉及支付、座位鎖定、狀態管理等多個子系統，需系統性釐清
- **時間精度**：場次衝突檢查與過期判斷對時間邏輯要求高，需精確定義
- **權限管理**：角色與權限缺乏明確定義，建議提前釐清以指導 API 設計

### 與 Formulation 階段的接駁

- Discovery 已完成，產出 51 個結構化釐清項目檔案
- `.clarify/overview.md` 提供了清晰的釐清順序與優先級
- 可直接進入 `formulation.md` 階段，按優先級與依賴關係進行互動式釐清
- 每個釐清項目的檔案格式支援 Formulation 階段的自動解析與呈現

## 8. 檔案結構

```
.clarify/
├── data/                          # 資料模型釐清項目（14 項）
├── features/                      # 功能模型釐清項目（37 項）
├── resolved/                      # 已解決的釐清項目
│   ├── data/
│   └── features/
└── overview.md                    # 本文件（釐清策略與優先級）
```

---

**生成時間**：2025-12-08  
**掃描範圍**：spec/erm.dbml, spec/features/*.feature（16 個 feature 檔案）  
**釐清項目總數**：51 項  
**下一步**：執行 `formulation.md` prompt 進行互動式釐清


